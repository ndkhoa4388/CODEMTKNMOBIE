<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>


<style>
:root {
--dark-bg-primary: #1a1a1d;
--dark-bg-secondary: #252830;
--dark-bg-tertiary: #313543;
--dark-text-primary: #e0e0e7;
/* Màu chữ chính, sáng */
--dark-text-secondary: #a0a0ac;
--dark-border-color: #4a4e5f;
--dark-accent-blue: #2997ff;
--dark-accent-blue-lighter: #5cadff;
--dark-accent-blue-darker: #1f78cf;

--status-success-text: #50fa7b;
/* Xanh lá cây sáng */
--status-error-text: #ff5555; /* Đỏ sáng */
--status-warning-text: #f1fa8c;
/* Vàng chanh (cho kỹ năng chưa đạt) */
--status-amber-text: #FFBF00;
/* Vàng cam (cho biểu đồ tự chủ - chưa đạt) */
--button-text-light: #ffffff;


--shadow-color-light: rgba(0, 0, 0, 0.3);
--shadow-color-medium: rgba(0, 0, 0, 0.4);
--shadow-color-dark: rgba(0, 0, 0, 0.5);

--sidebar-width: 250px;
--sidebar-width-collapsed: 80px; /* NEW: Thêm chiều rộng khi thu gọn */
--sidebar-transition-speed: 0.3s;


--brand-green: #4CAF50;
--brand-green-darker: #388E3C;
}


body {
font-family: 'Roboto', 'Arial', sans-serif;
margin: 0;
padding: 0;
display: flex;
height: 100vh;
background-color: var(--dark-bg-primary);
color: var(--dark-text-primary);
box-sizing: border-box;
overflow-x: hidden;
}
.sidebar {
width: var(--sidebar-width);
background-color: var(--dark-bg-secondary);
color: var(--dark-text-primary);
padding: 20px 0px;
box-sizing: border-box;
overflow-y: auto;
overflow-x: hidden; /* NEW: Ngăn thanh cuộn ngang xuất hiện khi chuyển đổi */
box-shadow: 2px 0 5px var(--shadow-color-light);
transition: transform var(--sidebar-transition-speed) ease-in-out, width var(--sidebar-transition-speed) ease-in-out;
flex-shrink: 0;
position: fixed;
left: 0;
top: 0;
height: 100%;
z-index: 100;
display: flex; 
flex-direction: column; 
}

/* NEW: Định nghĩa class cho text của button để dễ dàng ẩn/hiện */
.button-text {
    margin-left: 15px;
    transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
    white-space: nowrap; /* Ngăn text xuống dòng khi chuyển động */
}


.sidebar.collapsed {
/* On mobile, this will be overridden to hide completely */
width: var(--sidebar-width-collapsed);
}
.sidebar.active { /* For mobile: when sidebar is open */
    width: var(--sidebar-width);
    transform: translateX(0);
}


.sidebar img {
width: 100px;
height: 100px; /* NEW: Thêm chiều cao để chuyển động mượt hơn */
display: block;
margin: 0 auto 20px;
border-radius: 8px;
transition: width var(--sidebar-transition-speed) ease, height var(--sidebar-transition-speed) ease;
}
.sidebar.collapsed img {
    width: 45px;
    height: 45px;
}

.sidebar h2 {
font-size: 18px;
margin-bottom: 20px;
text-align: center;
display: flex;
align-items: center;
justify-content: center;
color: var(--dark-text-primary);
padding: 0 10px;
transition: opacity 0.2s, visibility 0.2s;
}

.sidebar.collapsed h2 {
    opacity: 0;
    visibility: hidden;
    height: 0;
    margin: 0;
    padding: 0;
}


.sidebar button {
width: 100%;
padding: 12px 30px; /* Adjusted padding */
margin: 4px 0;
font-size: 16px;
background-color: transparent;
color: var(--dark-text-secondary);
border: none;
border-left: 4px solid transparent;
cursor: pointer;
transition: background-color 0.2s, color 0.2s, border-left-color 0.2s;
position: relative;
font-weight: 500;
border-radius: 0;
display: flex; /* Changed to flex for alignment */
align-items: center;
overflow: hidden; /* NEW */
}

.sidebar.collapsed button {
    justify-content: center;
    padding: 12px 0;
}

.sidebar.collapsed .button-text {
    opacity: 0;
    visibility: hidden;
    width: 0;
    margin-left: 0;
}

.sidebar button i {
width: 20px;
text-align: center;
color: var(--dark-text-secondary);
transition: color 0.2s;
flex-shrink: 0; /* NEW: Ngăn icon bị co lại */
}


.sidebar button:hover {
background-color: var(--dark-bg-tertiary);
color: var(--dark-text-primary);
border-left-color: var(--dark-accent-blue);
}
.sidebar button:hover i {
color: var(--dark-accent-blue);
}


.sidebar button.active {
background-color: var(--dark-accent-blue);
color: var(--button-text-light);
border-left: 4px solid var(--dark-accent-blue);
}
.sidebar button.active i {
color: var(--button-text-light);
}

.sidebar-footer {
margin-top: auto;
padding: 20px 10px 15px 10px;
text-align: center;
color: var(--dark-text-secondary);
font-size: 12px;
line-height: 1.5;
transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
}
.sidebar-footer p {
margin: 0;
white-space: nowrap; /* NEW */
}
.sidebar-footer .name {
font-weight: 500;
color: var(--dark-text-primary);
}
.sidebar.collapsed .sidebar-footer {
opacity: 0;
visibility: hidden;
}


.main-content {
flex-grow: 1;
padding: 20px;
overflow-y: auto;
background-color: var(--dark-bg-primary);
max-width: 100%;
margin: 20px auto;
margin-left: calc(var(--sidebar-width) + 20px);
border-radius: 10px;
box-shadow: 0 2px 10px var(--shadow-color-medium);
position: relative;
transition: margin-left var(--sidebar-transition-speed) ease-in-out;
box-sizing: border-box;
}
.main-content.sidebar-collapsed {
margin-left: calc(var(--sidebar-width-collapsed) + 20px);
}



#sidebarToggleBtn {
position: fixed;
top: 15px;
left: var(--sidebar-width);
z-index: 101;
background-color: var(--dark-bg-secondary);
color: var(--dark-text-primary);
padding: 10px 8px;
border: 1px solid var(--dark-border-color);
border-left: none;
border-radius: 0 8px 8px 0;
cursor: pointer;
transition: left var(--sidebar-transition-speed) ease-in-out, background-color 0.2s;
font-size: 18px;
line-height: 1;
box-shadow: 2px 0px 5px rgba(0,0,0,0.1);
}
#sidebarToggleBtn:hover {
background-color: var(--dark-bg-tertiary);
}
#sidebarToggleBtn.collapsed {
left: var(--sidebar-width-collapsed);
}


#loginScreen,
#testSelectionScreen > h2,
#testScreen,
#resultScreen,
#testLookupScreen > h1,
#testLookupScreen > .instructions + input + button,
#testLookupScreen > p#lookupMessage,
#dashboardScreen {
text-align: center;
}
#trainingScreen, #personnelScreen, #personnelDetailScreen, #testDetailScreen,
#testSelectionScreen > .bg-white,
#testLookupScreen > .instructions, #roadmapScreen {
text-align: left;
}
.hidden { display: none; }


button {
padding: 8px 16px;
margin: 5px;
font-size: 16px;
max-width: 200px;
background-color: var(--dark-accent-blue);
color: var(--button-text-light);
border: none;
border-radius: 5px;
cursor: pointer;
transition: background-color 0.3s, transform 0.2s;
position: relative;
}
.main-content > div > button, .main-content > div > div > button {
width: auto;
}
#testSelectionScreen .bg-white button {
width: 100%;
}
button:hover {
background-color: var(--dark-accent-blue-darker);
transform: translateY(-1px);
}


select, input[type="text"], input[type="password"] {
padding: 10px;
margin: 10px auto;
width: 100%;
max-width: 320px;
font-size: 16px;
background-color: var(--dark-bg-tertiary);
color: var(--dark-text-primary);
border: 1px solid var(--dark-border-color);
border-radius: 5px;
display: block;
box-sizing: border-box;
}
#employeeCode:focus, #lookupEmployeeCode:focus, select:focus, #managerUsername:focus, #managerPassword:focus {
outline: none;
border-color: var(--dark-accent-blue);
box-shadow: 0 0 8px rgba(41, 151, 255, 0.5);
}
#employeeCode::placeholder, #lookupEmployeeCode::placeholder, #managerUsername::placeholder, #managerPassword::placeholder {
color: var(--dark-text-secondary);
}
.blinking-cursor::after {
content: '|';
position: absolute;
right: 10px;
top: 50%;
transform: translateY(-50%);
color: var(--dark-accent-blue);
animation: blink 1s step-end infinite;
}
@keyframes blink {
50% { opacity: 0;
}
}


#questions, #documents, #testHistory, #personnelScreen, #personnelDetailScreen, #managementScreen, #roadmapContainer {
text-align: left;
width: 100%;
font-size: 14px;
}
#questions .question {
background-color: var(--dark-bg-secondary);
padding: 15px;
margin: 15px 0;
border-radius: 8px;
box-shadow: 0 1px 4px var(--shadow-color-light);
border-left: 3px solid var(--dark-accent-blue);
}
#questions .question p {
font-size: 16px;
font-weight: bold;
margin-bottom: 12px;
color: var(--dark-text-primary);
}
#questions label {
display: block;
margin: 8px 0;
font-size: 15px; /* Kích thước chữ đáp án trên desktop */
color: var(--dark-text-secondary);
cursor: pointer;
}
@media (max-width: 768px) {
    #questions label {
        font-size: 16px;
/* Tăng kích thước chữ đáp án trên mobile */
    }
}
#questions label input[type="radio"] {
    vertical-align: middle;
}


#resultDetails, #testDetails {
text-align: left;
width: 100%;
margin-top: 20px;
font-size: 15px;
background-color: var(--dark-bg-secondary);
padding: 15px;
border-radius: 8px;
box-shadow: 0 1px 4px var(--shadow-color-light);
}
#resultDetails p, #testDetails p {
margin: 10px 0;
line-height: 1.6;
}
#resultDetails hr, #testDetails hr {
border: 0;
height: 1px;
background-color: var(--dark-border-color);
margin: 15px 0;
}


h1 {
font-size: 1.6em;
margin-bottom: 25px;
color: var(--dark-text-primary);
display: flex;
align-items: center;
}
#loginScreen h1 { color: var(--dark-accent-blue); justify-content: center; margin-top: 20px; }
#testScreen h2#testTitle, #resultScreen h2, #testDetailScreen h2 { color: var(--dark-accent-blue); justify-content: center;
}


#trainingScreen h1, #personnelScreen h1, #personnelDetailScreen h1,
#testLookupScreen h1, #dashboardScreen h1, #managementScreen h1,
#testSelectionScreen > h2, #roadmapScreen h1 {
color: var(--dark-accent-blue);
justify-content: flex-start;
padding-left: 5px;
}
#testSelectionScreen > h2 { padding-left:0; justify-content: center; }




h1 i {
margin-right: 10px;
}
h2 {
font-size: 1.4em;
color: var(--dark-text-primary);
margin-bottom: 18px;
}
#userInfo {
font-size: 20px;
font-weight: bold;
color: var(--dark-accent-blue);
margin-bottom: 6px;
text-shadow: none;
}
#employeeCodeDisplay {
font-size: 15px;
color: var(--status-error-text);
margin-bottom: 15px;
font-weight: 500;
}
.correct { color: var(--status-success-text); font-weight: bold; }
.incorrect { color: var(--status-error-text);
font-weight: bold; }


/* Đổi màu kỹ năng chưa đạt sang vàng */
.skill-not-met {
color: var(--status-warning-text) !important;
font-weight: bold !important;
}
#managementPersonnelListContainer td.skill-not-met {
background-color: rgba(241, 250, 140, 0.1);
color: var(--status-warning-text) !important;
}




p#loginMessage, p#lookupMessage, p#managementLoginMessage {
color: var(--status-error-text);
font-weight: 500;
margin-top: 15px;
min-height: 20px;
}


input[type="radio"], input[type="checkbox"] {
transform: scale(1.2);
margin-right: 8px;
accent-color: var(--dark-accent-blue);
}


#documents .group-section {
margin-bottom: 30px;
background-color: var(--dark-bg-secondary);
padding: 20px;
border-radius: 8px;
box-shadow: 0 2px 6px var(--shadow-color-medium);
}
#documents .group-section h3 {
font-size: 1.3em;
color: var(--dark-accent-blue);
margin-bottom: 20px;
border-bottom: 2px solid var(--dark-accent-blue);
padding-bottom: 10px;
}
#documents .group-documents {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 25px;
padding: 10px 0;
}
#documents a {
position: relative;
display: flex;
flex-direction: column;
padding: 20px;
padding-bottom: 45px;
background: linear-gradient(145deg, var(--dark-bg-tertiary), var(--dark-bg-secondary));
border-radius: 8px;
text-decoration: none;
font-size: 14px;
font-weight: 500;
box-shadow: 0 3px 7px var(--shadow-color-light);
transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
cursor: pointer;
min-height: 150px;
}


#documents a:hover {
transform: translateY(-3px) scale(1.03);
box-shadow: 0 5px 12px var(--shadow-color-medium);
background: linear-gradient(145deg, var(--dark-bg-secondary), var(--dark-bg-tertiary));
}


#documents a .doc-title {
font-size: 17px;
font-weight: bold;
color: var(--dark-text-primary);
margin-bottom: 8px;
}


#documents a .doc-desc {
font-size: 13px;
color: var(--dark-text-secondary);
margin-bottom: 12px;
line-height: 1.5;
flex-grow: 1;
}


.doc-card-icon-bottom {
position: absolute;
bottom: 12px;
left: 15px;
font-size: 20px;
color: var(--dark-accent-blue);
}


#documents a .doc-status.viewed {
position: absolute;
top: 10px;
right: 10px;
font-size: 12px;
padding: 3px 10px;
border-radius: 12px;
background-color: var(--status-success-text);
color: var(--dark-bg-primary);
font-weight: 500;
}
#documents .no-documents {
grid-column: span 2;
text-align: center;
color: var(--dark-text-secondary);
font-size: 16px;
padding: 25px;
background-color: var(--dark-bg-secondary);
border-radius: 8px;
}


.popup {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.7);
z-index: 10000;
justify-content: center;
align-items: center;
}
.popup-content {
background-color: var(--dark-bg-secondary);
width: 85%;
max-width: 850px;
height: 85%;
border-radius: 10px;
padding: 20px;
position: relative;
box-shadow: 0 4px 20px var(--shadow-color-dark);
display: flex;
flex-direction: column;
overflow-y: auto;
}
.popup-content iframe {
width: 100%;
flex-grow: 1;
border: 1px solid var(--dark-border-color);
border-radius: 5px;
margin-bottom: 15px;
}
.popup-buttons {
text-align: right;
flex-shrink: 0;
}
.popup-buttons button {
margin-left: 10px;
width: auto;
padding: 10px 22px;
font-weight: 500;
}
.popup-buttons .close-btn { background-color: #c0392b;
}
.popup-buttons .close-btn:hover { background-color: #e74c3c; }
.popup-buttons .full-btn { background-color: #219653; }
.popup-buttons .full-btn:hover { background-color: #27ae60; }


.dashboard-buttons { margin-top: 25px;
text-align: center; }
.dashboard-buttons button { margin: 0 12px; width: auto; padding: 10px 25px;
font-weight: 500;}
.dashboard-buttons .close-btn { background-color: #c0392b;
}
.dashboard-buttons .close-btn:hover { background-color: #e74c3c; }
.dashboard-buttons .full-btn { background-color: #219653; }
.dashboard-buttons .full-btn:hover { background-color: #27ae60; }


.loading-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(10, 10, 10, 0.85);
display: none;
justify-content: center;
align-items: center;
z-index: 10001;
}
.loading-spinner {
font-size: 4em;
color: var(--dark-accent-blue);
animation: spin 1s linear infinite;
}
@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg);
}
}


.instructions {
font-size: 14px;
color: var(--dark-text-secondary);
margin: 20px auto;
text-align: left;
max-width: 350px;
padding: 15px;
background-color: var(--dark-bg-secondary);
border-left: 4px solid var(--dark-accent-blue);
border-radius: 6px;
box-shadow: 0 1px 3px var(--shadow-color-light);
}
.instructions ul {
padding-left: 20px;
margin-top: 8px;
}
.instructions p { margin-bottom: 8px; line-height: 1.6;
}


#testHistory table, #personnelScreen table, #personnelDetailScreen table, #managementScreen table {
width: 100%;
border-collapse: collapse;
margin-top: 25px;
font-size: 14px;
background-color: var(--dark-bg-secondary);
box-shadow: 0 2px 6px var(--shadow-color-medium);
border-radius: 8px;
overflow: hidden;
}
#testHistory table th, #personnelScreen table th, #personnelDetailScreen table th, #managementScreen table th {
padding: 12px 15px;
text-align: left;
background-color: var(--dark-accent-blue);
color: var(--button-text-light);
font-weight: 500;
text-transform: uppercase;
border-bottom: 2px solid var(--dark-accent-blue-darker);
}
#testHistory table td, #personnelScreen table td, #personnelDetailScreen table td, #managementScreen table td {
padding: 12px 15px;
text-align: left;
border-bottom: 1px solid var(--dark-border-color);
color: var(--dark-text-primary);
}
#testHistory table tr:nth-child(even),
#personnelScreen table tr:nth-child(even),
#personnelDetailScreen table tr:nth-child(even),
#managementScreen table tr:nth-child(even) {
background-color: var(--dark-bg-tertiary);
}
#testHistory table tr:hover,
#personnelScreen table tr:hover,
#personnelDetailScreen table tr:hover,
#managementScreen table tr:hover {
background-color: #3b3f50;
cursor: pointer;
}
#testHistory .no-tests, #personnelScreen .no-personnel, #managementScreen .no-personnel, #roadmapContainer .no-roadmap-data {
text-align: center;
color: var(--dark-text-secondary);
font-size: 16px;
padding: 20px;
background-color: var(--dark-bg-secondary);
border-radius: 8px;
}

/* Sửa lại để thông tin nhân sự nằm bên phải avatar */
#personnelDetailScreen .personnel-info-grid {
display: grid;
grid-template-columns: 200px auto;
/* Avatar 200px, thông tin tự động điều chỉnh */
gap: 30px;
/* Khoảng cách giữa avatar và thông tin */
align-items: flex-start;
/* Căn chỉnh các mục theo phía trên cùng */
margin-bottom: 30px;
background-color: var(--dark-bg-secondary);
padding: 25px;
border-radius: 8px;
box-shadow: 0 3px 8px var(--shadow-color-medium);
}
#personnelDetailScreen .personnel-info-grid .personnel-image-container {
text-align: center;
/* Để avatar nằm giữa trong cột của nó */
}
.personnel-image {
width: 180px;
height: 180px;
object-fit: cover;
border-radius: 50%;
margin: 0 auto 15px; /* căn giữa hình ảnh và tạo khoảng cách với phần dưới */
display: block;
border: 5px solid var(--dark-accent-blue);
box-shadow: 0 0 15px rgba(41, 151, 255, 0.3);
}
#personnelDetailScreen .personnel-info-grid .personnel-data p {
margin: 8px 0;
font-size: 1.05em;
color: var(--dark-text-primary);
line-height: 1.6;
}
#personnelDetailScreen .personnel-info-grid .personnel-data p strong {
color: var(--dark-accent-blue);
min-width: 100px;
display: inline-block;
font-weight: 500;
}
#personnelDetailScreen .personnel-info-grid .personnel-data h2 {
margin-top:0;
margin-bottom:15px;
font-size:1.8em;
color: var(--dark-text-primary);
}


.job-desc-btn {
width: auto;
padding: 10px 20px;
background-color: var(--brand-green);
margin: 10px 0 18px 0;
display: inline-block;
color: white;
text-decoration: none;
border-radius: 5px;
font-size:1em;
transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
}
.job-desc-btn i { margin-right: 8px; }
.job-desc-btn:hover {
background-color: var(--brand-green-darker);
transform: translateY(-2px);
box-shadow: 0 3px 6px var(--shadow-color-light);
}


#personnelDetailScreen .skill-comparison,
.replacement-section,
.radar-chart-container {
margin-top: 25px;
margin-bottom: 30px;
background-color: var(--dark-bg-secondary);
padding:25px;
border-radius:8px;
box-shadow: 0 3px 8px var(--shadow-color-medium);
}
#personnelDetailScreen .skill-comparison h3,
.replacement-section h3,
.radar-chart-container h3 {
font-size: 1.4em;
color: var(--dark-accent-blue);
margin-bottom: 18px;
border-bottom: 2px solid var(--dark-accent-blue);
padding-bottom: 12px;
}
#personnelDetailScreen .skill-comparison th:nth-child(2),
#personnelDetailScreen .skill-comparison th:nth-child(3) {
width: 25%;
text-align: center;
}
#personnelDetailScreen .skill-comparison td:nth-child(2),
#personnelDetailScreen .skill-comparison td:nth-child(3) {
text-align: center;
font-weight: 500;
}


.skill-levels {
margin: 25px auto 15px;
text-align: left;
max-width: 400px;
padding: 18px 22px;
background-color: var(--dark-bg-secondary);
border-radius: 6px;
box-shadow: 0 1px 4px var(--shadow-color-light);
border: 1px solid var(--dark-border-color);
}
.skill-levels p {
font-weight: 500;
color: var(--dark-text-primary);
margin-bottom: 12px;
font-size: 16px;
}
.skill-levels ul {
padding-left: 0;
list-style-type: none;
}
.skill-levels li {
font-size: 14px;
color: var(--dark-text-secondary);
margin-bottom: 8px;
position: relative;
padding-left: 30px;
transition: color 0.3s;
line-height: 1.5;
}
.skill-levels li::before {
content: '\f058';
font-family: 'Font Awesome 6 Free';
font-weight: 900;
position: absolute;
left: 0;
color: var(--dark-accent-blue);
font-size: 18px;
top: 2px;
}
.skill-levels li:hover { color: var(--dark-accent-blue); }


.replacement-section ul {
list-style-type: none;
padding-left: 0;
}
.replacement-section li {
padding: 12px 8px;
color: var(--dark-text-primary);
border-bottom: 1px dashed var(--dark-border-color);
font-size: 1.1em;
transition: background-color 0.2s;
}
.replacement-section li:last-child { border-bottom: none; }
.replacement-section li:hover { background-color: var(--dark-bg-tertiary); }


#testSelectionScreen {
padding: 30px;
max-width: 700px;
margin: 30px auto;
background-color: var(--dark-bg-primary);
border-radius: 10px;
box-shadow: 0 4px 15px var(--shadow-color-medium);
}
#testSelectionScreen > h2 {
font-size: 1.9rem;
margin-bottom: 2.2rem;
color: var(--dark-accent-blue);
text-align: center;
}
#testSelectionScreen .bg-white {
background-color: var(--dark-bg-secondary);
border: 1px solid var(--dark-border-color);
border-radius: 8px;
box-shadow: 0 2px 8px var(--shadow-color-light);
padding: 2rem;
margin-bottom: 2rem;
}
#testSelectionScreen h3 {
font-size: 1.3rem;
margin-bottom: 1.4rem;
color: var(--dark-accent-blue);
}
#testSelectionScreen ul {
padding-left: 1.8rem;
color: var(--dark-text-secondary);
font-size: 1.1em;
}
#testSelectionScreen ul li { margin-bottom: 0.5rem; line-height: 1.6; }


#testSelectionScreen select {
appearance: none;
background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20' stroke-width='2' stroke='%23e0e0e7' class='w-5 h-5'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19.5 8.25l-7.5 7.5-7.5-7.5'/%3E%3C/svg%3E");
background-repeat: no-repeat;
background-position: right 1rem center;
background-size: 1.4em 1.4em;
width: 100%;
padding: 0.9rem 1.2rem;
border: 1px solid var(--dark-border-color);
border-radius: 0.375rem;
font-size:1.1rem;
background-color: var(--dark-bg-tertiary);
color: var(--dark-text-primary);
}
#testSelectionScreen select:focus {
border-color: var(--dark-accent-blue);
box-shadow: 0 0 0 0.25rem rgba(41, 151, 255, 0.3);
}


#testSelectionScreen button {
font-size: 1.2rem;
padding: 0.9rem 1.8rem;
border: none;
cursor: pointer;
width: 100%;
font-weight: 500;
background-color: var(--dark-accent-blue);
color: var(--button-text-light);
}
#testSelectionScreen button:hover {
background-color: var(--dark-accent-blue-darker);
}
#testSelectionScreen .text-gray-700 { color: var(--dark-text-secondary); }
#testSelectionScreen .space-y-2 > * + * { margin-top: 0.6rem;
}


.radar-chart-container {
width: 100%;
max-width: 700px;
margin-left: auto;
margin-right: auto;
box-sizing: border-box;
height: 530px;
}
#radarChartCanvas {
max-width: 100%;
width: 100% !important;
height: 100% !important;
display: block;
margin: 0 auto;
}


#personnelDetailScreen > button, #testDetailScreen > button {
display: block;
margin: 30px auto 15px;
width: auto;
padding: 12px 28px;
font-size: 1.1em;
background-color: var(--dark-bg-tertiary);
color: var(--dark-text-primary);
}
#personnelDetailScreen > button:hover, #testDetailScreen > button:hover {
background-color: #4a4e5f;
}


.management-kpi-container {
display: flex;
justify-content: space-around;
margin-bottom: 30px;
flex-wrap: wrap;
gap:15px;
}
.kpi-card {
background-color: var(--dark-bg-secondary);
padding: 20px;
border-radius: 8px;
text-align: center;
box-shadow: 0 2px 6px var(--shadow-color-medium);
min-width: 200px;
flex: 1;
}
.kpi-card h3 {
color: var(--dark-accent-blue);
margin-top:0;
margin-bottom: 10px;
font-size: 1.1em;
}
.kpi-card p {
font-size: 2em;
font-weight: bold;
color: var(--dark-text-primary);
margin: 0;
}


.management-charts-container {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
margin-bottom: 30px;
}
.chart-card {
background-color: var(--dark-bg-secondary);
padding:20px;
border-radius:8px;
box-shadow: 0 2px 6px var(--shadow-color-medium);
display: flex;
flex-direction: column;
align-items: center;
}
.chart-card h3 {
color:var(--dark-accent-blue);
text-align:center;
margin-top:0;
margin-bottom:15px;
}
.chart-card canvas {
max-width: 100%;
max-height: 300px;
}


/* Sửa lỗi đoạn code lặp lại */
.management-personnel-analysis .cite-error-block {
    display: none;
/* Ẩn hoàn toàn đoạn lỗi này */
}

.management-personnel-analysis {
background-color: var(--dark-bg-secondary);
padding:25px;
border-radius:8px;
box-shadow: 0 3px 8px var(--shadow-color-medium);
margin-top: 30px;
}
.management-personnel-analysis h3 {
font-size: 1.4em;
color: var(--dark-accent-blue);
margin-bottom: 18px;
border-bottom: 2px solid var(--dark-accent-blue);
padding-bottom: 12px;
}
.management-personnel-analysis .filters {
margin-bottom:20px;
display: flex;
align-items: center;
}
.management-personnel-analysis .filters label {
color: var(--dark-text-primary);
margin-right: 20px;
display: inline-flex;
align-items: center;
}
.management-personnel-analysis .filters input[type="checkbox"] {
margin-right: 5px;
}
.management-personnel-analysis .filters button { /* Nút xóa bộ lọc */
padding: 5px 10px;
font-size: 0.9em;
margin-left: 10px;
}

/* Roadmap specific styles */
.roadmap-group-card {
    background-color: var(--dark-bg-secondary);
    border-radius: 8px;
    box-shadow: 0 2px 6px var(--shadow-color-medium);
    margin-bottom: 20px;
    overflow: hidden; /* Ensures border-radius is applied to children */
}

.roadmap-group-header {
    background-color: var(--dark-accent-blue);
    color: var(--button-text-light);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    font-size: 1.2em;
    font-weight: 500;
    transition: background-color 0.2s ease;
}

.roadmap-group-header:hover {
    background-color: var(--dark-accent-blue-darker);
}

.roadmap-group-header .progress-info {
    font-size: 0.9em;
    background-color: rgba(0, 0, 0, 0.2);
    padding: 5px 10px;
    border-radius: 5px;
    margin-left: 20px;
}

.roadmap-group-header i {
    transition: transform 0.3s ease;
}

.roadmap-group-header.collapsed i {
    transform: rotate(-90deg);
}

.roadmap-details {
    padding: 0px; /* Adjust padding as needed, will be overridden by JS for hidden state */
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease-out, padding 0.5s ease-out;
}

.roadmap-details.expanded {
    max-height: 1000px; /* Large enough to show content */
    padding: 20px;
}

/* Wrapper for horizontal scroll */
.table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
}

/* Custom scrollbar styles */
.table-responsive::-webkit-scrollbar {
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: var(--dark-bg-primary); /* Darker track */
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: var(--dark-border-color); /* Matches border color */
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: var(--dark-accent-blue); /* Accent color on hover */
}


.roadmap-group table {
    width: 100%; /* Ensure table takes full width of its wrapper */
    border-collapse: collapse;
    margin-top: 0px; /* Adjust margin as it's inside the card */
    box-shadow: none; /* Remove redundant shadow */
    border-radius: 0; /* Remove redundant border-radius */
    /* Remove overflow-x from table itself, move to .table-responsive */
}


.roadmap-group table th, 
.roadmap-group table td {
    border: 1px solid var(--dark-border-color);
    padding: 12px 25px; /* Tăng padding ngang và dọc */
    text-align: center; /* Căn giữa tất cả nội dung chữ */
    white-space: nowrap; /* Ngăn không cho chữ xuống dòng */
    overflow: hidden; /* Ẩn phần bị tràn */
    text-overflow: ellipsis; /* Thêm dấu ba chấm nếu bị cắt */
    box-sizing: border-box; /* Include padding and border in element's total width */
}

/* Specific width for some columns to help prevent overflow */
.roadmap-group table th:nth-child(1), /* STT */
.roadmap-group table td:nth-child(1) {
    min-width: 60px; /* STT column width */
}

.roadmap-group table th:nth-child(2), /* BƯỚC */
.roadmap-group table td:nth-child(2) {
    min-width: 90px; /* Tăng min-width */
}
.roadmap-group table th:nth-child(3), /* CÔNG VIỆC */
.roadmap-group table td:nth-child(3) {
    min-width: 280px; /* Thêm min-width cho cột Công việc */
    max-width: 400px; /* Giới hạn max-width cho Công việc nếu quá dài */
    white-space: normal; /* Cho phép Công việc xuống dòng nếu cần thiết */
    text-overflow: clip; /* Bỏ ellipsis nếu cho phép xuống dòng */
    text-align: left; /* Căn trái cho cột CÔNG VIỆC nếu xuống dòng */
}

.roadmap-group table th:nth-child(4), /* BẮT ĐẦU */
.roadmap-group table td:nth-child(4),
.roadmap-group table th:nth-child(5), /* KẾT THÚC */
.roadmap-group table td:nth-child(5) {
    min-width: 130px; /* Provide enough space for dates */
}

.roadmap-group table th:nth-child(6), /* TUẦN BẮT ĐẦU */
.roadmap-group table td:nth-child(6),
.roadmap-group table th:nth-child(7), /* TUẦN KẾT THÚC */
.roadmap-group table td:nth-child(7),
.roadmap-group table th:nth-child(8), /* THỜI GIAN */
.roadmap-group table td:nth-child(8) {
    min-width: 110px; /* Tăng min-width một chút */
}

.roadmap-group table th:nth-child(9), /* CẬP NHẬT TIẾN ĐỘ */
.roadmap-group table td:nth-child(9) {
    min-width: 160px; /* Min width for dropdown */
    max-width: 160px;
}
.roadmap-group table td select {
    width: 100%;
    padding: 6px 8px; /* Slightly reduced padding for dropdown */
    font-size: 13px;
    box-sizing: border-box; /* Ensures padding is included in total width */
}


.roadmap-group table th {
    background-color: var(--dark-bg-tertiary); /* Lighter header for sub-table */
    color: var(--dark-text-primary);
    font-weight: 500;
    text-transform: none; /* No uppercase for sub-table headers */
    border-bottom: 1px solid var(--dark-border-color);
}

.roadmap-group table tr:nth-child(even) {
  background-color: var(--dark-bg-primary); /* Use primary for even rows for contrast */
}

.roadmap-group table tr:hover {
  background-color: #313543; /* Hover for sub-table rows */
}

.roadmap-completed-row {
  background-color: rgba(80, 250, 123, 0.15) !important; /* light green */
}

.roadmap-current-row {
  background-color: rgba(255, 191, 0, 0.15) !important; /* light amber */
}

/* Responsive Design */
@media (max-width: 768px) {
    /* --- MOBILE: Sidebar slides out completely --- */
    .sidebar {
        width: 0;
        transform: translateX(-100%);
        padding-left: 0;
        padding-right: 0;
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        box-shadow: 2px 0 5px var(--shadow-color-light);
    }
    .sidebar.active {
        width: var(--sidebar-width);
        transform: translateX(0);
        padding-left: 20px;
        padding-right: 20px;
    }
    .sidebar button {
        white-space: normal;
        text-overflow: clip;
        height: auto;
        padding: 10px 15px;
        line-height: 1.2;
        display: block;
        text-align: center;
    }
     .sidebar .button-text {
        margin-left: 0; /* Reset for mobile */
    }
    .sidebar button i {
        margin-right: 0;
        display: block;
        margin-bottom: 5px;
        float: none;
        text-align: center;
    }
    .sidebar button:last-child {
        margin-bottom: 20px;
    }

    #sidebarToggleBtn {
        display: block;
        left: 0;
        border-radius: 0 8px 8px 0;
        border: 1px solid var(--dark-border-color);
        border-left: none;
        top: 15px;
    }
    /* On mobile, when collapsed, the toggle button is at left: 0 */
     #sidebarToggleBtn.collapsed {
        left: 0;
    }

    .main-content {
        margin-left: 0;
        width: 100%;
        border-radius: 0;
        padding: 15px;
        margin-top: 0;
        box-shadow: none;
    }
    .main-content.sidebar-collapsed {
        margin-left: 0;
    }

    /* Adjust font sizes and spacing for smaller screens */
    h1 { font-size: 1.4em;
margin-bottom: 15px; justify-content: center; }
    h2 { font-size: 1.2em; margin-bottom: 12px;
}
    .sidebar h2 { font-size: 16px; margin-bottom: 10px;
}
   
    select, input[type="text"], input[type="password"] { max-width: 100%; font-size: 14px; padding: 8px;
}
    button { padding: 10px 15px; font-size: 14px; max-width: 100%;
}

    #questions .question p { font-size: 15px;
}
    /* Sửa lỗi cỡ chữ đáp án quá nhỏ trên điện thoại */
    #questions label { font-size: 16px;
/* Tăng kích thước chữ đáp án trên mobile */ }

    #documents .group-documents { grid-template-columns: 1fr;
} /* Single column for documents */
    #documents a { min-height: 120px; padding: 15px; padding-bottom: 40px;
}
    #documents a .doc-title { font-size: 16px; }
    #documents a .doc-desc { font-size: 12px;
}

    .popup-content { width: 95%; height: 90%; padding: 15px;
}
    .popup-buttons button { padding: 8px 15px; font-size: 0.9em;
}

    #personnelDetailScreen .personnel-info-grid {
        grid-template-columns: 1fr;
/* Stack elements vertically */
        text-align: center;
/* Center content */
        gap: 15px;
/* Reduce gap */
    }
    #personnelDetailScreen .personnel-info-grid .personnel-image-container {
        margin-bottom: 15px;
/* Add some space below image */
    }
    .personnel-image { width: 120px; height: 120px;
margin: 0 auto; } /* Smaller, centered avatar */
    #personnelDetailScreen .personnel-info-grid .personnel-data h2 { font-size: 1.5em;
margin-top: 10px; } /* Adjust heading size */
    #personnelDetailScreen .personnel-info-grid .personnel-data p { font-size: 0.95em;
}
    .job-desc-btn { width: 80%; margin: 10px auto; display: block;
} /* Center and make wider */


    .radar-chart-container { height: 350px;
} /* Smaller radar chart height */

    .management-kpi-container { flex-direction: column; gap: 10px;
}
    .kpi-card { min-width: unset; width: 100%; }
    .management-charts-container { grid-template-columns: 1fr;
} /* Single column for charts */
    .management-personnel-analysis .filters { flex-direction: column; align-items: flex-start;
}
    .management-personnel-analysis .filters label { margin-bottom: 10px; margin-right: 0;
}
    .management-personnel-analysis .filters button { width: 100%; margin-left: 0;
}
}

/* Tablet and larger screens */
@media (min-width: 769px) {
    .sidebar {
        transform: translateX(0%);
    }
    /* Keep old collapsed state for mobile behavior */
    .sidebar.collapsed {
        transform: translateX(0); /* Override mobile transform */
        width: var(--sidebar-width-collapsed);
    }
    .main-content {
        margin-left: calc(var(--sidebar-width) + 20px);
    }
    .main-content.sidebar-collapsed {
        margin-left: calc(var(--sidebar-width-collapsed) + 20px);
    }
    #sidebarToggleBtn {
        left: var(--sidebar-width);
        display: block;
    }
    #sidebarToggleBtn.collapsed {
        left: var(--sidebar-width-collapsed);
    }
}
</style>
</head>
<body>
<div id="sidebarToggleBtn"><i class="fas fa-chevron-left"></i></div>


<div class="sidebar" id="sidebar">
<div> <img src="https://i.imgur.com/eyCXZVI.jpeg" alt="Logo">
<h2><i class="fas fa-bars"></i><span class="button-text"> Menu</span></h2>

<button id="trainingBtn" onclick="showTraining()"><i class="fas fa-book"></i><span class="button-text">Tài liệu đào tạo</span></button>
<button id="testBtn" onclick="showTest()"><i class="fas fa-pen"></i><span class="button-text">Làm bài kiểm tra</span></button>
<button id="lookupBtn" onclick="showTestLookup()"><i class="fas fa-search"></i><span class="button-text">Tra cứu bài làm</span></button>
<button id="dashboardBtn" onclick="showDashboard()"><i class="fas fa-chart-line"></i><span class="button-text">Dashboard</span></button>
<button id="personnelBtn" onclick="showPersonnel()"><i class="fas fa-users"></i><span class="button-text">Tổng hợp nhân sự</span></button>
<button id="roadmapBtn" onclick="showRoadmap()"><i class="fas fa-map-signs"></i><span class="button-text">Lộ trình</span></button>
<button id="managementBtn" onclick="showManagementLoginPopup()"><i class="fas fa-user-shield"></i><span class="button-text">Quản lý</span></button>
</div>

<div class="sidebar-footer">
<p class="name">NGUYỄN ĐĂNG KHOA</p>
<p>Email: ndkhoa4388@gmail.com</p>
</div>
</div>


<div class="main-content" id="mainContent">
<div class="loading-overlay" id="loadingOverlay">
<i class="fas fa-spinner loading-spinner"></i>
</div>


<div id="trainingScreen" class="hidden">
<h1><i class="fas fa-book-open"></i> TÀI LIỆU ĐÀO TẠO</h1>
<div id="documents"></div>
</div>


<div id="loginScreen">
<h1>Bài kiểm tra kỹ năng cơ bản - Kho vật tư Hunex</h1>
<h2>Đăng Nhập</h2>
<div class="instructions">
<p>Dùng mã nhân viên của bạn để đăng 
nhập.</p>
</div>
<input type="text" id="employeeCode" class="blinking-cursor" placeholder="Nhập mã nhân viên" /><br>
<button onclick="login()">Đăng Nhập</button>
<div class="skill-levels">
<p>Có tất cả 5 cấp độ kỹ năng:</p>
<ul>
<li>NA (Hay còn gọi là cấp độ 0): Tôi chưa cần kỹ năng này</li>
<li>Cấp 1: Tôi cần được đào tạo kỹ năng này.</li>
<li>Cấp 2: Tôi đã được đào tạo kỹ năng này.</li>
<li>Cấp độ 3: Tôi đã thành thạo kỹ năng này</li>
<li>Cấp độ 4: Tôi có thể đào tạo người khác kỹ năng này.</li>
</ul>
</div>
<p id="loginMessage"></p>
</div>


<div id="testSelectionScreen" class="hidden">
<h2><i class="fas fa-clipboard-list mr-2"></i> Chọn Bài Kiểm Tra</h2>
<div class="bg-white p-6 rounded-lg shadow-md mb-6">
<h3><i class="fas fa-info-circle mr-2"></i> Hướng dẫn</h3>
<ul class="list-disc list-inside text-gray-700 space-y-2">
<li>Chọn bài kiểm tra muốn thực 
hiện.</li>
<li>Mỗi bài làm có thời gian tối đa 15 phút/lần làm bài.</li>
<li>Không giới hạn số lần làm bài.</li>
</ul>
</div>
<div class="bg-white p-6 rounded-lg shadow-md mb-6">
<label for="testGroup" class="text-lg font-semibold mb-2 flex items-center">
<i class="fas fa-list mr-2"></i> Chọn bài kiểm tra
</label>
<select id="testGroup" class="w-full p-2 border rounded-md mb-4">
<option value="" disabled selected>Chọn bài kiểm tra</option>
</select>
<button onclick="startTest()" class="w-full py-3 rounded-md flex items-center justify-content-center">
<i class="fas fa-play mr-2"></i> Bắt Đầu
</button>
</div>
<div class="bg-white p-6 rounded-lg shadow-md">
<h3><i class="fas fa-trophy mr-2"></i> Quy định cấp độ kỹ năng dựa trên điểm số</h3>
<ul class="list-disc list-inside text-gray-700 space-y-2">
<li>Đạt 0 điểm: Cấp độ 0.</li>
<li>Đạt 1-2-3 điểm: Cấp độ 1.</li>
<li>Đạt 4 điểm: Cấp độ 2.</li>
<li>Đạt 5 điểm: Cấp độ 
3.</li>
<li><strong>Đặc biệt:</strong> Quản lý kho đã có giấy xác nhận từ ban giám đốc đủ khả năng đào tạo, sau khi tái kiểm tra đạt 5 điểm sẽ đạt cấp độ 4.</li>
</ul>
</div>
</div>


<div id="testScreen" class="hidden">
<p id="userInfo"></p>
<p id="employeeCodeDisplay"></p>
<h2 id="testTitle"></h2>
<p id="timer"></p>
<div id="questions"></div>
<button onclick="submitTest()">Nộp Bài</button>
</div>


<div id="resultScreen" class="hidden">
<h2>Kết Quả</h2>
<p id="result"></p>
<div id="resultDetails"></div>
<button onclick="restart()">Làm Lại</button>
</div>


<div id="testLookupScreen" class="hidden">
<h1><i class="fas fa-search"></i> TRA CỨU BÀI LÀM</h1>
<div class="instructions">
<p>Nhập mã nhân viên để tra cứu lịch sử bài làm.</p>
</div>
<input type="text" id="lookupEmployeeCode" class="blinking-cursor" placeholder="Nhập mã nhân viên" /><br>
<button onclick="lookupTests()">Tra cứu</button>
<p id="lookupMessage"></p>
<div id="testHistory"></div>
</div>


<div id="testDetailScreen" class="hidden">
<h2>Chi Tiết Bài Làm</h2>
<p id="testResult"></p>
<div id="testDetails"></div>
<button onclick="backToLookup()">Quay Lại</button>
</div>


<div id="dashboardScreen" class="hidden">
<h1><i class="fas fa-chart-line"></i> DASHBOARD</h1>
<p>Nhấn nút "Xem dashboard" để xem dashboard.</p>
<div class="dashboard-buttons">
<button 
class="full-btn" onclick="openFullDashboard()">Xem dashboard</button>
<button class="close-btn" onclick="closeDashboard()">Đóng</button>
</div>
</div>


<div id="personnelScreen" class="hidden">
<h1><i class="fas fa-users"></i> TỔNG HỢP NHÂN SỰ</h1>
<div id="personnelList"></div>
</div>


<div id="personnelDetailScreen" class="hidden">
<h1><i class="fas fa-user"></i> CHI TIẾT NHÂN SỰ</h1>
<div id="personnelDetails"></div>
<button onclick="backToPersonnelList()">Quay Lại Danh Sách</button>
</div>

<div id="roadmapScreen" class="hidden">
    <h1><i class="fas fa-map-signs"></i> LỘ TRÌNH CẬP NHẬT KỸ NĂNG</h1>
    <div id="roadmapContainer">
        <p class="no-roadmap-data">Đang tải dữ liệu lộ trình...</p>
    </div>
</div>


<div id="managementScreen" class="hidden">
<div style="display: flex;
justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h1><i class="fas fa-chart-pie"></i> TRANG QUẢN LÝ</h1>
<span id="managerNameDisplay" style="color: var(--dark-accent-blue); font-weight: bold; font-size: 1.2em;
margin-right: 15px;"></span>
<button id="logoutButton" onclick="logoutManager()" style="background-color: var(--dark-bg-tertiary); padding: 8px 15px;">Thoát</button>
</div>


<div class="management-kpi-container">
<div class="kpi-card">
<h3 >Tổng Số Nhân Viên</h3>
<p id="totalEmployeesStat">N/A</p>
</div>
<div class="kpi-card">
<h3 >NV Tự Chủ 100%</h3>
<p id="autonomyAchievedStat">N/A</p>
</div>
</div>


<div class="management-charts-container">
<div class="chart-card">
<h3 >Tỷ Lệ Kỹ Năng Tự Chủ</h3>
<canvas id="managementAutonomyChart"></canvas>
</div>
<div class="chart-card">
<h3 >Phân Bố Độ Tuổi</h3>
<canvas id="managementAgeChart"></canvas>
</div>
<div class="chart-card">
<h3 >Tỷ Lệ Giới Tính</h3>
<canvas id="managementGenderChart"></canvas>
<p id="genderChartMessage" style="text-align:center;
font-size:0.9em; color:var(--dark-text-secondary); margin-top:10px;"></p>
</div>
<div class="chart-card">
<h3 >Tỷ Lệ Chức Danh</h3>
<canvas id="managementPositionChart"></canvas>
</div>
</div>


<div class="management-personnel-analysis">
<h3 >Phân Tích Kỹ Năng Nhân Sự</h3>
<div class="filters">
<label>
<input type="checkbox" id="filterUnmetSkills" onchange="applyManagementFilters()">
Hiển thị nhân viên có kỹ năng thực tế chưa đạt mục tiêu
</label>
<button onclick="resetChartFilters()" style="background-color: var(--dark-bg-tertiary);
color: var(--dark-text-primary);">Xóa bộ lọc biểu đồ</button>
</div>
<div id="managementPersonnelListContainer">
<p class="no-personnel">Chưa có dữ liệu nhân sự hoặc bộ lọc không có kết quả.</p>
</div>
</div>
</div>


</div>


<div id="documentPopup" class="popup">
<div class="popup-content">
<iframe id="documentIframe" src=""></iframe>
<div class="popup-buttons">
<button class="full-btn" onclick="openFullDocument()">Mở full</button>
<button class="close-btn" onclick="closePopup()">Đóng</button>
</div>
</div>
</div>


<div id="managementLoginPopup" class="popup">
<div class="popup-content" style="max-width: 400px;
height: auto; background-color: var(--dark-bg-secondary); padding:25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
<h2 style="text-align: center; color: var(--dark-accent-blue); margin-top:0;
margin-bottom: 20px;">Đăng Nhập Quản Lý</h2>
<label for="managerUsername" style="margin-top:10px; color: var(--dark-text-secondary); font-size: 0.9em;">Tên đăng nhập:</label>
<input type="text" id="managerUsername" placeholder="Tên đăng nhập" style="margin: 5px auto 15px auto;"/>
<label for="managerPassword" style="margin-top:10px;
color: var(--dark-text-secondary); font-size: 0.9em;">Mật khẩu:</label>
<input type="password" id="managerPassword" placeholder="Mật khẩu" style="margin: 5px auto 20px auto;"/>
<p id="managementLoginMessage"></p>
<div class="popup-buttons" style="text-align: center;
margin-top:10px;">
<button onclick="handleManagementLogin()" style="background-color: var(--dark-accent-blue); color: var(--button-text-light); padding: 10px 20px; font-size: 1em;">Đăng Nhập</button>
<button class="close-btn" onclick="closeManagementLoginPopup()" style="padding: 10px 20px;
font-size: 1em;">Hủy</button>
</div>
</div>
</div>

<script>
// Đăng ký plugin datalabels toàn cục
Chart.register(ChartDataLabels);

// BIẾN TOÀN CỤC
const APPS_SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbwmPWHiU7mbh2gWW1ABUSL4Gdw48Tj8nqVqmbhR_zKLKzj7uW55xKT576LFodZ2S-GO/exec'; 

let currentQuestions = [];
let employeeCode = "";
let fullName = "";
let currentTestGroup = "";
let timerInterval;
let timeLeft = 900;
let userAnswers = [];
let currentDocumentLink = "";
let viewedDocuments = new Set();
let allTests = [];
let allPersonnel = []; // Khởi tạo mảng rỗng để tránh lỗi "undefined"
const dashboardLink = "https://lookerstudio.google.com/reporting/a98e41fb-430d-42a2-91f7-c6f08443f500";
let radarChartInstance = null;
const SIDEBAR_COLLAPSED_KEY = 'sidebarCollapsed';
const MANAGER_LOGGED_IN_KEY = 'managerLoggedIn';
const MANAGER_FULL_NAME_KEY = 'managerFullName';


let isManagerLoggedIn = false;
let managerFullName = "";
let managementAutonomyChartInstance = null;
let managementAgeChartInstance = null;
let managementGenderChartInstance = null;
let managementPositionChartInstance = null;
let currentChartFilters = {}; // Lưu trữ các bộ lọc đang được áp dụng từ biểu đồ

// ==========================================================================================
// START: SỬA LỖI TÍNH NĂNG LÀM NỔI BẬT CÔNG VIỆC HIỆN TẠI
// Thay thế ngày cố định bằng ngày hiện tại của hệ thống.
// ==========================================================================================
const CURRENT_DATE = new Date();
CURRENT_DATE.setHours(0, 0, 0, 0); // Chuẩn hóa về đầu ngày (00:00:00) để so sánh chính xác chỉ dựa trên ngày, tháng, năm.
// ==========================================================================================
// END: SỬA LỖI
// ==========================================================================================


// --- HÀM TIỆN ÍCH CHO SIDEBAR ---
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    const toggleIcon = toggleBtn.querySelector('i');

    const isMobile = window.innerWidth <= 768;
    if (isMobile) {
        sidebar.classList.toggle('active'); // Use 'active' for mobile to show/hide
        if (sidebar.classList.contains('active')) {
            toggleIcon.classList.remove('fa-chevron-right');
            toggleIcon.classList.add('fa-chevron-left');
        } else {
            toggleIcon.classList.remove('fa-chevron-left');
            toggleIcon.classList.add('fa-chevron-right');
        }
    } else {
        // Desktop behavior
        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('sidebar-collapsed');
        toggleBtn.classList.toggle('collapsed');
        if (sidebar.classList.contains('collapsed')) {
            toggleIcon.classList.remove('fa-chevron-left');
            toggleIcon.classList.add('fa-chevron-right');
            localStorage.setItem(SIDEBAR_COLLAPSED_KEY, 'true');
        } else {
            toggleIcon.classList.remove('fa-chevron-right');
            toggleIcon.classList.add('fa-chevron-left');
            localStorage.setItem(SIDEBAR_COLLAPSED_KEY, 'false');
        }
    }
}


function applyInitialSidebarState() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    const toggleIcon = toggleBtn.querySelector('i');

    const isMobile = window.innerWidth <= 768;
    const isCollapsedOnDesktop = localStorage.getItem(SIDEBAR_COLLAPSED_KEY) === 'true' && !isMobile;

    // Reset classes first
    sidebar.classList.remove('collapsed', 'active');
    mainContent.classList.remove('sidebar-collapsed');
    toggleBtn.classList.remove('collapsed');
    toggleIcon.classList.remove('fa-chevron-left', 'fa-chevron-right');

    if (isMobile) {
        // On mobile, sidebar is hidden by default using transform.
        sidebar.style.transform = 'translateX(-100%)';
        sidebar.style.width = 'var(--sidebar-width)'; // Ensure width is correct when it slides in
        mainContent.style.marginLeft = '0';
        toggleBtn.style.left = '0';
        toggleIcon.classList.add('fa-chevron-right');
    } else {
        // On desktop, apply stored state or default
        sidebar.style.transform = 'translateX(0)'; // Ensure sidebar is visible
        if (isCollapsedOnDesktop) {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
            toggleBtn.classList.add('collapsed');
            toggleIcon.classList.add('fa-chevron-right');
        } else {
            // Default desktop state: sidebar open
            sidebar.classList.remove('collapsed');
            mainContent.classList.remove('sidebar-collapsed');
            toggleBtn.classList.remove('collapsed');
            toggleIcon.classList.add('fa-chevron-left'); // Points left to collapse
        }
    }
}

window.addEventListener('resize', applyInitialSidebarState);
// --- CÁC HÀM HIỂN THỊ VÀ LOGIC CÒN LẠI ---
function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}


function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}


function showTraining() {
    hideAllScreens();
    document.getElementById('trainingScreen').classList.remove('hidden');
    setActiveButton('trainingBtn');
    showLoading();
    loadDocuments();
}


function showTest() {
    hideAllScreens();
    document.getElementById('loginScreen').classList.remove('hidden');
    setActiveButton('testBtn');
}


function showTestLookup() {
    hideAllScreens();
    document.getElementById('testLookupScreen').classList.remove('hidden');
    document.getElementById('lookupEmployeeCode').value = '';
    document.getElementById('lookupMessage').innerText = '';
    document.getElementById('testHistory').innerHTML = '';
    setActiveButton('lookupBtn');
}


function showDashboard() {
    hideAllScreens();
    document.getElementById('dashboardScreen').classList.remove('hidden');
    setActiveButton('dashboardBtn');
}


function showPersonnel() {
    hideAllScreens();
    document.getElementById('personnelScreen').classList.remove('hidden');
    setActiveButton('personnelBtn');
    showLoading();
    loadPersonnel();
}

function showRoadmap() {
    hideAllScreens();
    document.getElementById('roadmapScreen').classList.remove('hidden');
    setActiveButton('roadmapBtn');
    showLoading();
    loadRoadmapData();
}


function hideAllScreens() {
    document.getElementById('trainingScreen').classList.add('hidden');
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('testSelectionScreen').classList.add('hidden');
    document.getElementById('testScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.add('hidden');
    document.getElementById('testLookupScreen').classList.add('hidden');
    document.getElementById('testDetailScreen').classList.add('hidden');
    document.getElementById('dashboardScreen').classList.add('hidden');
    document.getElementById('personnelScreen').classList.add('hidden');
    document.getElementById('personnelDetailScreen').classList.add('hidden');
    document.getElementById('managementScreen').classList.add('hidden');
    document.getElementById('roadmapScreen').classList.add('hidden');


    closePopup();
    closeManagementLoginPopup();
    hideLoading();
    removeActiveButton();
    if (radarChartInstance) {
        radarChartInstance.destroy();
        radarChartInstance = null;
    }
    // Destroy existing Chart.js instances to prevent memory leaks and redraw issues
    if (managementAutonomyChartInstance) { managementAutonomyChartInstance.destroy();
        managementAutonomyChartInstance = null; }
    if (managementAgeChartInstance) { managementAgeChartInstance.destroy(); managementAgeChartInstance = null; }
    if (managementGenderChartInstance) { managementGenderChartInstance.destroy(); managementGenderChartInstance = null;
    }
    if (managementPositionChartInstance) { managementPositionChartInstance.destroy(); managementPositionChartInstance = null; }
}


function setActiveButton(buttonId) {
    removeActiveButton();
    const button = document.getElementById(buttonId);
    if (button) {
        button.classList.add('active');
    }
}


function removeActiveButton() {
    const buttons = document.querySelectorAll('.sidebar button');
    buttons.forEach(btn => btn.classList.remove('active'));
}


function openFullDashboard() {
    if (dashboardLink) {
        window.open(dashboardLink, '_blank');
    }
}


function closeDashboard() {
    hideAllScreens();
    document.getElementById('loginScreen').classList.remove('hidden');
    setActiveButton('testBtn');
}


function loadPersonnel() {
    showLoading();
    fetch(`${APPS_SCRIPT_API_URL}?action=getPersonnelData`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (!data) {
                console.error("Dữ liệu nhân sự trả về là null hoặc undefined");
                const container = document.getElementById('personnelList');
                container.innerHTML = '<p class="no-personnel" style="color: var(--status-error-text);">Lỗi: Dữ liệu nhân sự trả về không hợp lệ.</p>';
                return;
            }
            allPersonnel = data;
            const container = document.getElementById('personnelList');
            container.innerHTML = '';
            if (!Array.isArray(allPersonnel) || allPersonnel.length === 0) {
                container.innerHTML = '<p class="no-personnel">Không tìm thấy nhân viên nào.</p>';
                return;
            }
            let html = `
<table>
<thead>
<tr>
<th>STT</th>
<th>Mã Nhân Viên</th>
<th>Họ và Tên</th>
<th>Tuổi</th>
<th>Thâm Niên</th>
<th>Chức Danh</th>
<th>Nhóm Vật Tư</th>
</tr>
</thead>
<tbody>
`;
            allPersonnel.forEach((person, index) => {
                html += `
<tr onclick="showPersonnelDetails(${index})">
<td>${index + 1}</td>
<td>${person.fullName || 'N/A'}</td>
<td>${person.employeeCode || 'N/A'}</td>
<td>${person.age || 'N/A'}</td>
<td>${person.seniority || 'N/A'}</td>
<td>${person.position || 'N/A'}</td>
<td>${person.materialGroup || 'N/A'}</td>
</tr>
`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        })
        .catch(error => {
            hideLoading();
            console.error("Lỗi khi tải danh sách nhân viên: ", error);
            const container = document.getElementById('personnelList');
            container.innerHTML = '<p class="no-personnel" style="color: var(--status-error-text);">Lỗi khi tải danh sách nhân viên: ' + error.message + '</p>';
        });
}


function openJobDescription(link) {
    if (link && link.trim() !== '') {
        window.open(link, '_blank');
    } else {
        alert('Không có liên kết mô tả công việc cho nhân viên này.');
    }
}


function formatRadarLabel(label, maxCharsPerLine = 15) {
    const words = label.split(' ');
    let lines = [];
    let currentLine = '';
    if (label.length <= maxCharsPerLine) {
        return [label];
    }


    for (let i = 0; i < words.length; i++) {
        const word = words[i];
        if (currentLine.length === 0) {
            currentLine = word;
        } else if (currentLine.length + 1 + word.length <= maxCharsPerLine) {
            currentLine += ' ' + word;
        } else {
            if (currentLine.length > 0) {
                lines.push(currentLine);
            }
            currentLine = word;
            if (word.length > maxCharsPerLine && lines.length === 0 && i === 0) { // Handle single very long word
                lines.push(word);
                currentLine = '';
            }
        }
    }
    if (currentLine.length > 0) {
        lines.push(currentLine);
    }
    return lines.length > 0 ? lines : [label];
}


function showPersonnelDetails(index) {
    if (!allPersonnel || index < 0 || index >= allPersonnel.length) {
        console.error("Dữ liệu nhân viên không hợp lệ hoặc chỉ số không đúng: ", index);
        return;
    }
    const person = allPersonnel[index];


    hideAllScreens();
    document.getElementById('personnelDetailScreen').classList.remove('hidden');
    setActiveButton('personnelBtn');
    const container = document.getElementById('personnelDetails');
    container.innerHTML = '';
    const basicSkills = [
        "Đặc tính cơ bản và phân loại vật tư", "5S", "Hiểu quy trình nhập - xuất nguyên liệu",
        "Lưu trữ, bảo quản vật tư", "Hiểu các loại tem nhãn sử dụng trong kho"
    ];
    let basicSkillsList = [];
    let specializedSkillsList = [];


    if (person.skills && Array.isArray(person.skills)) {
        person.skills.forEach(skill => {
            // Only include skills with a target > 0, excluding the overall autonomy skill if it somehow got mixed in
            if (parseFloat(skill.target) > 0 && skill.name.toLowerCase().trim() !== "tỉ lệ kỹ năng tự chủ") {
                const normalizedSkillName = skill.name ? skill.name.trim().toLowerCase() : '';
                const isBasicSkill = basicSkills.some(basicSkill => basicSkill.toLowerCase().trim() === normalizedSkillName);
                if (isBasicSkill) basicSkillsList.push(skill);
                else specializedSkillsList.push(skill);
            }
        });
    }


    let autonomySkill = null;
    if (person.overallSkills && Array.isArray(person.overallSkills)) {
        autonomySkill = person.overallSkills.find(skill => skill.name && skill.name.trim().toLowerCase() === "tỉ lệ kỹ năng tự chủ");
    }


    let replacedBy = [];
    allPersonnel.forEach(otherPerson => {
        if (otherPerson.fullName && otherPerson.fullName !== person.fullName) {
            if (otherPerson.replacements && otherPerson.replacements.includes(person.fullName)) {
                replacedBy.push(otherPerson.fullName);
            }
        }
    });
    let replacements = [];
    if (person.replacements && Array.isArray(person.replacements)) {
        replacements = person.replacements
            .filter(name => name && name.trim() && name !== person.fullName)
            .filter((name, idx, self) => self.indexOf(name) === idx);
    }


    let html = `
<div class="personnel-info-grid">
<div class="personnel-image-container">
<img src="${person.imageUrl || 'https://via.placeholder.com/180?text=No+Image'}" alt="Ảnh ${person.fullName}" class="personnel-image"
onerror="this.onerror=null; this.src='https://via.placeholder.com/180?text=Error';">
</div>
<div class="personnel-data">
<h2>${person.fullName || 'N/A'} (Mã NV: ${person.employeeCode || 'N/A'})</h2>
<p><strong>Chức Danh:</strong> ${person.position || 'N/A'}</p>
<p><strong>Tuổi:</strong> ${person.age || 'N/A'}</p>
<p><strong>Thâm Niên:</strong> ${person.seniority || 'N/A'}</p>
<p><strong>Nhóm Vật Tư:</strong> ${person.materialGroup || 'N/A'}</p>
${person.jobDescriptionLink ? `<a href="#" onclick="openJobDescription('${person.jobDescriptionLink}'); return false;"
class="job-desc-btn"><i class="fas fa-briefcase"></i> Mô tả công việc</a>` : '<p><em>(Không có MTCV)</em></p>'}
</div>
</div>
<div class="skill-comparison"><h3>Tổng quan kỹ năng</h3><table><thead><tr><th>Kỹ năng</th><th>Thực tế</th><th>Mục tiêu</th></tr></thead><tbody>`;
    if (person.overallSkills && Array.isArray(person.overallSkills)) {
        person.overallSkills.forEach(skill => {
            if (skill.name.toLowerCase().trim() !== "tỉ lệ kỹ năng tự chủ" && parseFloat(skill.target) === 0 && parseFloat(skill.current) === 0) return;
            let currentDisplay = skill.current;
            let targetDisplay = skill.target;
            let isMet = parseFloat(skill.current) >= parseFloat(skill.target);
            if (skill.name.toLowerCase().trim() === 'tỉ lệ kỹ năng tự chủ') {
                currentDisplay = `<strong>${skill.current || '0'}</strong>%`;
                targetDisplay = `${skill.target || '100'}%`;
                isMet = parseFloat(skill.current) >= (parseFloat(skill.target) || 100);
            }
            html += `<tr><td>${skill.name || 'N/A'}</td>
<td><span class="${isMet ? 'correct' : 'skill-not-met'}">${currentDisplay}</span></td>
<td>${targetDisplay}</td></tr>`;
        });
    } else { html += '<tr><td colspan="3" style="text-align:center;">Không có dữ liệu kỹ năng tổng thể.</td></tr>';
    }
    if (!autonomySkill && (!person.overallSkills || !person.overallSkills.find(s => s.name.toLowerCase().trim() === "tỉ lệ kỹ năng tự chủ"))) {
        html += `<tr><td>Tỉ lệ kỹ năng tự chủ</td><td><span class="skill-not-met"><strong>0</strong>%</span></td><td>100%</td></tr>`;
    }
    html += `</tbody></table></div>`;


    if (basicSkillsList.length > 0) {
        html += `<div class="skill-comparison"><h3>Kỹ năng cơ bản</h3><table><thead><tr><th>Kỹ năng</th><th>Thực tế / Mục tiêu</th></tr></thead><tbody>`;
        basicSkillsList.forEach(skill => { html += `<tr><td>${skill.name || 'N/A'}</td><td><span class="${parseFloat(skill.current) >= parseFloat(skill.target) ? 'correct' : 'skill-not-met'}">${skill.current || '0'} / ${skill.target || '0'}</span></td></tr>`; });
        html += `</tbody></table></div>`;
    } else {
        html += `<div class="skill-comparison"><h3>Kỹ năng cơ bản</h3><p style="text-align:center; padding:10px;">Không có kỹ năng cơ bản nào được yêu cầu (mục tiêu > 0).</p></div>`;
    }


    if (specializedSkillsList.length > 0) {
        html += `<div class="skill-comparison"><h3>Kỹ năng chuyên môn (Bảng)</h3><table><thead><tr><th>Kỹ năng</th><th>Thực tế / Mục tiêu</th></tr></thead><tbody>`;
        specializedSkillsList.forEach(skill => { html += `<tr><td>${skill.name || 'N/A'}</td><td><span class="${parseFloat(skill.current) >= parseFloat(skill.target) ? 'correct' : 'skill-not-met'}">${skill.current || '0'} / ${skill.target || '0'}</span></td></tr>`; });
        html += `</tbody></table></div>`;
    } else {
        html += `<div class="skill-comparison"><h3>Kỹ năng chuyên môn (Bảng)</h3><p style="text-align:center; padding:10px;">Không có kỹ năng chuyên môn nào được yêu cầu (mục tiêu > 0) trong bảng này.</p></div>`;
    }


    html += `
<div class="radar-chart-container">
<h3>Biểu đồ Kỹ năng Chuyên môn</h3>
<canvas id="radarChartCanvas"></canvas>
</div>`;
    if (replacements.length > 0 || replacedBy.length > 0) {
        html += `<div class="replacement-section">`;
        if (replacements.length > 0) {
            html += `<h3>${person.fullName} có thể được thay thế bởi:</h3><ul>${replacements.map(name => `<li>${name}</li>`).join('')}</ul>`;
        }
        if (replacedBy.length > 0) {
            html += `<h3>${person.fullName} có thể thay thế cho:</h3><ul>${replacedBy.map(name => `<li>${name}</li>`).join('')}</ul>`;
        }
        html += `</div>`;
    }
    container.innerHTML = html;
    const radarSkillsForChart = person.radarSkills;
    const radarContainerEl = document.querySelector('.radar-chart-container');


    if (radarSkillsForChart && Array.isArray(radarSkillsForChart) && radarSkillsForChart.length > 0) {
        const radarLabels = radarSkillsForChart.map(skill => formatRadarLabel(skill.name));
        const radarValues = radarSkillsForChart.map(skill => skill.value);
        const radarChartCanvasEl = document.getElementById('radarChartCanvas');


        if (radarChartCanvasEl) {
            const ctxRadar = radarChartCanvasEl.getContext('2d');
            if (radarChartInstance) {
                radarChartInstance.destroy();
            }


            radarChartInstance = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: radarLabels,
                    datasets: [{
                        label: `Kỹ năng của ${person.fullName}`,
                        data: radarValues,
                        fill: true,
                        backgroundColor: 'rgba(41, 151, 255, 0.25)',
                        borderColor: 'rgb(41, 151, 255)',
                        pointBackgroundColor: 'rgb(41, 151, 255)',
                        pointBorderColor: '#FFFFFF', /* Đổi màu chú thích sang TRẮNG */
                        pointHoverBackgroundColor: '#FFFFFF', /* Đổi màu chú thích sang TRẮNG */
                        pointHoverBorderColor: 'rgb(31, 120, 207)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { left: 15, right: 15, top: 10, bottom: 15 } },
                    elements: { line: { tension: 0.05 } },
                    scales: {
                        r: {
                            angleLines: { display: true, color: 'rgba(224, 224, 231, 0.2)' },
                            suggestedMin: 0,
                            suggestedMax: 4,
                            ticks: { stepSize: 1, backdropColor: 'rgba(0,0,0,0)', color: '#FFFFFF', font: {size:10, weight:'500'} }, /* Đổi màu chú 
thích sang TRẮNG */
                            pointLabels: { font: {size:11, weight:'500'}, color: '#FFFFFF' }, /* Đổi màu chú thích sang TRẮNG */
                            grid: { color: 'rgba(224, 224, 231, 0.15)' }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: {
                            usePointStyle: true, // THÊM DÒNG NÀY ĐỂ CHÚ THÍCH LÀ HÌNH TRÒN
                            font: {size:13, weight:'500'},
                            color: '#FFFFFF', /* Đổi màu chú thích sang TRẮNG */
                            padding: 20
                        } },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(30,30,30,0.85)',
                            titleFont:{size:14, weight:'bold', color: '#FFFFFF'},
                            bodyFont:{size:13, color: '#FFFFFF'},
                            padding:10,
                            cornerRadius:4,
                            titleColor: '#FFFFFF',
                            bodyColor: '#FFFFFF',
                            callbacks: {
                                labelTextColor: function(context) { return '#FFFFFF';
                                },
                                label: function(context) { const label=Array.isArray(context.label)?context.label.join(' '):context.label; return `${label}: ${context.raw}`; }
                            }
                        }
                    }
                }
            });
        } else {
            console.error("Không tìm thấy thẻ canvas '#radarChartCanvas' sau khi chèn HTML.");
            if(radarContainerEl) radarContainerEl.innerHTML += '<p style="text-align:center; color:var(--status-error-text); padding: 20px;">Lỗi: Không thể tải biểu đồ (không tìm thấy canvas).</p>';
        }
    } else {
        if (radarContainerEl) {
            radarContainerEl.innerHTML = '<h3>Biểu đồ Kỹ năng Chuyên môn</h3><p style="text-align:center; color:var(--dark-text-secondary); padding: 20px;">Không có dữ liệu kỹ năng chuyên môn để hiển thị biểu đồ radar cho nhân viên này.</p>';
        }
        if (radarChartInstance) {
            radarChartInstance.destroy();
            radarChartInstance = null;
        }
    }
}



function backToPersonnelList() {
    hideAllScreens();
    document.getElementById('personnelScreen').classList.remove('hidden');
    setActiveButton('personnelBtn');
}


function loadDocuments() {
    showLoading();
    fetch(`${APPS_SCRIPT_API_URL}?action=getTrainingDocuments`)
        .then(response => response.json())
        .then(documents => {
            hideLoading();
            const container = document.getElementById('documents');
            container.innerHTML = '';
            if (!documents || documents.length === 0) {
                container.innerHTML = '<p class="no-documents">Không có tài liệu nào để hiển thị.</p>';
                return;
            }
            const groups = {};
            documents.forEach(doc => {
                if (!groups[doc.group]) {
                    groups[doc.group] = [];
                }
                groups[doc.group].push(doc);
            });


            let html = '';
            for (const groupName in groups) {
                html += `<div class="group-section"><h3>${groupName}</h3><div class="group-documents">`;
                if (groups[groupName].length === 0) {
                    html += '<p class="no-documents">Không có tài liệu nào trong nhóm này.</p>';
                } else {
                    groups[groupName].forEach((doc) => {
                        const description = doc.note || "Không có ghi chú.";
                        const isViewed = viewedDocuments.has(doc.skill + '_' + doc.link);
                        const statusText = isViewed ? '<span class="doc-status viewed">Đã xem</span>' : '';
                        html += `
<a onclick="markAsViewedAndOpenPopup('${doc.skill}', '${doc.link}')">
<div class="doc-title">${doc.skill}</div>
<div class="doc-desc">${description}</div>
<i class="fas fa-folder doc-card-icon-bottom"></i>
${statusText}
</a>`;
                    });
                }
                html += `</div></div>`;
            }
            container.innerHTML = html;
        })
        .catch(error => {
            hideLoading();
            document.getElementById('documents').innerHTML = '<p class="no-documents" style="color: var(--status-error-text);">Lỗi khi tải tài liệu: ' + error.message + '</p>';
        });
}


function markAsViewedAndOpenPopup(skillName, link) {
    viewedDocuments.add(skillName + '_' + link);
    openPopup(link);
}


function openPopup(link) {
    currentDocumentLink = link;
    document.getElementById('documentIframe').src = link;
    document.getElementById('documentPopup').style.display = 'flex';
}


function closePopup() {
    document.getElementById('documentPopup').style.display = 'none';
    document.getElementById('documentIframe').src = 'about:blank';
    currentDocumentLink = '';
    if(document.getElementById('trainingScreen') && !document.getElementById('trainingScreen').classList.contains('hidden')) {
        loadDocuments();
    }
}


function openFullDocument() {
    if (currentDocumentLink) {
        window.open(currentDocumentLink, '_blank');
    }
}


function login() {
    employeeCode = document.getElementById('employeeCode').value.trim();
    if (!employeeCode) {
        document.getElementById('loginMessage').innerText = 'Vui lòng nhập mã nhân viên!';
        return;
    }
    showLoading();
    fetch(`${APPS_SCRIPT_API_URL}?action=checkLogin&employeeCode=${encodeURIComponent(employeeCode)}`)
        .then(response => response.json())
        .then(result => {
            hideLoading();
            if (result.isValid) {
                fullName = result.fullName;
                hideAllScreens();
                document.getElementById('testSelectionScreen').classList.remove('hidden');
                setActiveButton('testBtn');
                loadTestGroups();
            } else {
                document.getElementById('loginMessage').innerText = 'Mã nhân viên không đúng hoặc không tồn tại!';
            }
        })
        .catch(error => {
            hideLoading();
            document.getElementById('loginMessage').innerText = 'Lỗi đăng nhập: ' + error.message;
        });
}


function loadTestGroups() {
    showLoading();
    fetch(`${APPS_SCRIPT_API_URL}?action=getTestGroups`)
        .then(response => response.json())
        .then(groups => {
            hideLoading();
            const select = document.getElementById('testGroup');
            select.innerHTML = '<option value="" disabled selected>--- Chọn bài kiểm tra ---</option>';
            if (groups && groups.length > 0) {
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.text = group;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="" disabled selected>Không có bài kiểm tra nào</option>';
            }
        })
        .catch(error => {
            hideLoading();
            alert('Lỗi khi tải danh sách bài kiểm tra: ' + error.message);
        });
}


function startTest() {
    currentTestGroup = document.getElementById('testGroup').value;
    if (!currentTestGroup) {
        alert('Vui lòng chọn một bài kiểm tra!');
        return;
    }
    showLoading();
    fetch(`${APPS_SCRIPT_API_URL}?action=getRandomQuestions&testGroup=${encodeURIComponent(currentTestGroup)}`)
        .then(response => response.json())
        .then(questions => {
            hideLoading();
            currentQuestions = questions;
            if (!currentQuestions || currentQuestions.length === 0) {
                alert('Không có câu hỏi nào cho bài kiểm tra này. Vui lòng liên hệ quản trị viên.');
                return;
            }
            userAnswers = [];
            hideAllScreens();
            document.getElementById('testScreen').classList.remove('hidden');
            document.getElementById('userInfo').innerText = `Thí sinh: ${fullName}`;
            document.getElementById('employeeCodeDisplay').innerText = `Mã NV: ${employeeCode}`;
            document.getElementById('testTitle').innerText = `Bài kiểm tra: ${currentTestGroup}`;
            displayQuestions(questions);
            startTimer();
        })
        .catch(error => {
            hideLoading();
            alert('Không thể bắt đầu bài kiểm tra: ' + error.message);
        });
}


function displayQuestions(questions) {
    const container = document.getElementById('questions');
    container.innerHTML = '';
    questions.forEach((q, index) => {
        const correctAnswerTrimmed = String(q.correct).trim();
        const wrong1Trimmed = String(q.wrong1).trim();
        const wrong2Trimmed = String(q.wrong2).trim();


        const answers = [correctAnswerTrimmed, wrong1Trimmed, wrong2Trimmed].sort(() => Math.random() - 0.5);
        let html = `<div class="question"><p>${index + 1}. ${q.question}</p>`;
        answers.forEach(answer => {
            const escapedAnswer = answer.replace(/"/g, "&quot;");
            html += `<label><input type="radio" name="q${index}" value="${escapedAnswer}"> ${answer}</label><br>`;
        });
        html += `</div>`;
        container.innerHTML += html;
    });
}


function startTimer() {
    timeLeft = 900;
    updateTimerDisplay();
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(function() {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            alert('Đã hết thời gian làm bài!');
            submitTest();
        }
    }, 1000);
}


function updateTimerDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('timer').innerText = `Thời gian còn lại: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
}


function submitTest() {
    if(timerInterval) clearInterval(timerInterval);
    userAnswers = [];
    currentQuestions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        userAnswers.push(selected ? selected.value : 'Không trả lời');
    });
    showLoading();
    fetch(APPS_SCRIPT_API_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'checkAnswersAndSave',
            userAnswers: userAnswers,
            questions: currentQuestions,
            employeeCode: employeeCode,
            fullName: fullName,
            testGroup: currentTestGroup
        })
    })
    .then(response => response.json())
    .then(score => {
        hideLoading();
        hideAllScreens();
        document.getElementById('resultScreen').classList.remove('hidden');
        setActiveButton('testBtn');
        document.getElementById('result').innerText = `Chúc mừng! Bạn đã hoàn thành bài kiểm tra ${currentTestGroup} với ${score}/${currentQuestions.length} câu đúng!`;
        displayResultDetails();
    })
    .catch(error => {
        hideLoading();
        alert('Lỗi khi nộp bài: ' + error.message);
    });
}


function displayResultDetails() {
    const container = document.getElementById('resultDetails');
    container.innerHTML = '<h3>Chi tiết câu trả lời:</h3>';
    currentQuestions.forEach((q, index) => {
        const userAnswer = userAnswers[index];
        const correctAnswerTrimmed = String(q.correct).trim();
        const isCorrect = userAnswer === correctAnswerTrimmed;
        const resultClass = isCorrect ? 'correct' : 'incorrect';
        const resultText = isCorrect ? 'Đúng' : (userAnswer === "Không trả lời" ? "Chưa trả lời" : "Sai");
        // Đây là phần đã sửa lỗi cú pháp JSX/HTML trong template literal
        const detailHtml = `
<p><strong>Câu ${index + 1}: ${q.question}</strong></p>
<p>Trả lời của bạn: <span class="${resultClass}">${userAnswer}</span> (${resultText})</p>
<p>Đáp án đúng: <span class="correct">${correctAnswerTrimmed}</span></p>
<hr>`;
        container.innerHTML += detailHtml;
    });
}


function restart() {
    hideAllScreens();
    document.getElementById('testSelectionScreen').classList.remove('hidden');
    setActiveButton('testBtn');
}


function lookupTests() {
    let lookupCode = document.getElementById('lookupEmployeeCode').value.trim();
    if (!lookupCode) {
        document.getElementById('lookupMessage').innerText = 'Vui lòng nhập mã nhân viên!';
        return;
    }
    showLoading();
    fetch(`${APPS_SCRIPT_API_URL}?action=getTestHistory&employeeCode=${encodeURIComponent(lookupCode)}`)
        .then(response => response.json())
        .then(tests => {
            hideLoading();
            document.getElementById('lookupMessage').innerText = '';
            const container = document.getElementById('testHistory');
            container.innerHTML = '';
            if (!tests || tests.length === 0) {
                container.innerHTML = '<p class="no-tests">Không tìm thấy bài làm nào cho mã nhân viên này.</p>';
                return;
            }
            allTests = tests.sort((a, b) => parseDate(b.timestamp) - parseDate(a.timestamp));


            let html = `
<table>
<thead>
<tr><th>STT</th><th>Thời gian</th><th>Tên nhân viên</th><th>Nhóm bài kiểm tra</th><th>Kết quả (Điểm)</th></tr>
</thead>
<tbody>`;
            allTests.forEach((test, index) => {
                html += `
<tr onclick="showTestDetails(${index})">
<td>${index + 1}</td><td>${test.timestamp}</td><td>${test.fullName}</td><td>${test.testGroup}</td><td>${test.correctWrong} (${test.score}đ)</td>
</tr>
`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        })
        .catch(error => {
            hideLoading();
            document.getElementById('lookupMessage').innerText = 'Lỗi khi tra cứu: ' + error.message;
        });
}


function parseDate(timestamp) {
    if (!timestamp) return new Date(0);
    const parts = timestamp.match(/(\d{2})\/(\d{2})\/(\d{4})\s(\d{2}):(\d{2}):(\d{2})/);
    if (parts) {
        return new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], parts[6]);
    }
    const parsedDate = new Date(timestamp);
    return isNaN(parsedDate) ?
        new Date(0) : parsedDate;
}

// Function to parse dd-mm-yyyy dates for roadmap
function parseRoadmapDate(dateString) {
    if (!dateString) return null;
    const parts = dateString.split('-'); // Assumes dd-mm-yyyy
    if (parts.length === 3) {
        // Ensure year has 4 digits (e.g., handle '24' -> 2024 if necessary, though 'yyyy' implies 4)
        const year = parseInt(parts[2], 10);
        const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
        const day = parseInt(parts[0], 10);
        const date = new Date(year, month, day);
        // Check for validity (e.g., 31/02/2025 would be invalid)
        if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
            return date;
        }
    }
    return null;
}


function showTestDetails(index) {
    if (!allTests || index < 0 || index >= allTests.length) return;
    const test = allTests[index];
    hideAllScreens();
    document.getElementById('testDetailScreen').classList.remove('hidden');
    setActiveButton('lookupBtn');
    document.getElementById('testResult').innerText = `Kết quả: ${test.correctWrong} (${test.score} điểm) - ${test.testGroup} - ${test.timestamp}`;
    const container = document.getElementById('testDetails');
    container.innerHTML = '<h3>Chi tiết câu trả lời:</h3>';


    const questions = test.questions ? test.questions.split('|') : [];
    const answers = test.answers ? test.answers.split('|') : [];
    const correctAnswers = test.correctAnswers ? test.correctAnswers.split('|') : [];
    const numItems = questions.length > 0 ? questions.length : (test.correctWrong && test.correctWrong.includes('/') ? parseInt(test.correctWrong.split('/')[1]) : 0);
    for (let i = 0; i < numItems; i++) {
        const q = (i < questions.length && questions[i] ? questions[i] : "Không có câu hỏi").trim();
        const userAnswer = (i < answers.length && answers[i] ? answers[i] : "Không trả lời").trim();
        const correctAnswer = (i < correctAnswers.length && correctAnswers[i] ? correctAnswers[i] : "Không có đáp án").trim();
        if (q === "Không có câu hỏi" && userAnswer === "Không trả lời" && correctAnswer === "Không có đáp án" && i >= questions.length && (test.questions || "").split('|').length <= i) {
            if (!test.questions || test.questions.split('|').length <= i) continue;
        }


        const isCorrect = userAnswer === correctAnswer && q !== "Không có câu hỏi" && correctAnswer !== "Không có đáp án";
        const resultClass = isCorrect ? 'correct' : 'incorrect';
        let resultText = isCorrect ? 'Đúng' : (userAnswer === "Không trả lời" ? "Chưa trả lời" : "Sai");
        // Đây là phần đã sửa lỗi cú pháp JSX/HTML trong template literal
        const currentHtml = `
<p><strong>Câu ${i + 1}: ${q}</strong></p>
<p>Trả lời của bạn: <span class="${resultClass}">${userAnswer}</span> (${resultText})</p>
<p>Đáp án đúng: <span class="correct">${correctAnswer}</span></p>
<hr>`;
        container.innerHTML += currentHtml;
    }
}


function backToLookup() {
    hideAllScreens();
    document.getElementById('testLookupScreen').classList.remove('hidden');
    setActiveButton('lookupBtn');
}


// --- MANAGEMENT FUNCTIONS ---
function showManagementLoginPopup() {
    document.getElementById('managementLoginPopup').style.display = 'flex';
    document.getElementById('managementLoginMessage').innerText = '';
}


function closeManagementLoginPopup() {
    document.getElementById('managementLoginPopup').style.display = 'none';
}


function handleManagementLogin() {
    const username = document.getElementById('managerUsername').value;
    const password = document.getElementById('managerPassword').value;
    const loginMessage = document.getElementById('managementLoginMessage');
    if (username === "ndkhoa" && password === "dk431988") {
        isManagerLoggedIn = true;
        managerFullName = "Nguyễn Đăng Khoa";
        // Lưu trạng thái đăng nhập và tên người dùng vào localStorage
        localStorage.setItem(MANAGER_LOGGED_IN_KEY, 'true');
        localStorage.setItem(MANAGER_FULL_NAME_KEY, managerFullName);
        loginMessage.innerText = '';
        closeManagementLoginPopup();
        showManagementScreen();
    } else {
        loginMessage.innerText = 'Tên đăng nhập hoặc mật khẩu không đúng!';
        isManagerLoggedIn = false;
        managerFullName = "";
        localStorage.removeItem(MANAGER_LOGGED_IN_KEY);
        localStorage.removeItem(MANAGER_FULL_NAME_KEY);
    }
}


function showManagementScreen() {
    if (!isManagerLoggedIn) {
        // Nếu chưa đăng nhập, hiển thị popup đăng nhập
        showManagementLoginPopup();
        return;
    }
    hideAllScreens();
    document.getElementById('managementScreen').classList.remove('hidden');
    setActiveButton('managementBtn');
    // Chỉ hiển thị tên, không có "Chào," và làm nổi bật
    document.getElementById('managerNameDisplay').innerText = managerFullName;
    currentChartFilters = {};
    // Khởi tạo allPersonnel nếu nó chưa có dữ liệu (ví dụ: nếu tải lại trang sau khi đăng nhập quản lý)
    if (!allPersonnel || allPersonnel.length === 0) {
        showLoading();
        fetch(`${APPS_SCRIPT_API_URL}?action=getPersonnelData`)
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (!data) {
                    console.error("Dữ liệu nhân sự trả về là null hoặc undefined cho management.");
                    document.getElementById('managementPersonnelListContainer').innerHTML = '<p class="no-personnel" style="color: var(--status-error-text);">Lỗi: Không thể tải dữ liệu nhân sự cho trang quản lý.</p>';
                    return;
                }
                allPersonnel = data;
                loadManagementDashboardData(); // Call loadDashboardData AFTER allPersonnel is loaded
            })
            .catch(error => {
                hideLoading();
                console.error("Lỗi khi tải danh sách nhân viên cho trang quản lý: ", error);
                document.getElementById('managementPersonnelListContainer').innerHTML = '<p class="no-personnel" style="color: var(--status-error-text);">Lỗi khi tải dữ liệu: ' + error.message + '</p>';
            });
    } else {
        // Nếu allPersonnel đã có dữ liệu, chỉ cần tải dashboard
        loadManagementDashboardData();
    }
}


function logoutManager() {
    isManagerLoggedIn = false;
    managerFullName = "";
    localStorage.removeItem(MANAGER_LOGGED_IN_KEY); // Xóa trạng thái đăng nhập
    localStorage.removeItem(MANAGER_FULL_NAME_KEY);
    // Xóa tên người dùng
    currentChartFilters = {};
    hideAllScreens();
    document.getElementById('loginScreen').classList.remove('hidden'); // Trở về màn hình đăng nhập chính
    setActiveButton('testBtn');
    // Đặt button "Làm bài kiểm tra" là active mặc định
}


function loadManagementDashboardData() {
    if (!allPersonnel || allPersonnel.length === 0) {
        document.getElementById('totalEmployeesStat').innerText = '0';
        document.getElementById('autonomyAchievedStat').innerText = '0 (0%)';
        document.getElementById('managementPersonnelListContainer').innerHTML = '<p class="no-personnel">Không có dữ liệu nhân sự để hiển thị.</p>';
        return;
    }


    document.getElementById('totalEmployeesStat').innerText = allPersonnel.length;
    const autonomyAchievedCount = allPersonnel.filter(p => {
        const skill = p.overallSkills.find(s => s.name && s.name.toLowerCase().trim() === "tỉ lệ kỹ năng tự chủ");
        return skill && parseFloat(skill.current) >= (parseFloat(skill.target) || 100);
    }).length;
    const totalEmployees = allPersonnel.length > 0 ? allPersonnel.length : 1;
    document.getElementById('autonomyAchievedStat').innerText = `${autonomyAchievedCount} (${((autonomyAchievedCount / totalEmployees) * 100).toFixed(1)}%)`;


    renderManagementCharts();
    applyManagementFilters();
}

// ==========================================================================================
// NỘI DUNG HÀM renderManagementCharts() ĐƯỢC THAY THẾ BẮT ĐẦU TỪ ĐÂY
// ==========================================================================================
function renderManagementCharts() {
    // Destroy existing Chart.js instances
    if (managementAutonomyChartInstance) { managementAutonomyChartInstance.destroy();
        managementAutonomyChartInstance = null; }
    if (managementAgeChartInstance) { managementAgeChartInstance.destroy(); managementAgeChartInstance = null; }
    if (managementGenderChartInstance) { managementGenderChartInstance.destroy(); managementGenderChartInstance = null; }
    if (managementPositionChartInstance) { managementPositionChartInstance.destroy();
        managementPositionChartInstance = null; }

    const commonChartPlugins = {
        legend: {
            position: 'bottom',
            labels: {
                usePointStyle: true, // THÊM DÒNG NÀY ĐỂ CHÚ THÍCH LÀ HÌNH TRÒN
                color: '#FFFFFF',
                font: { size: 11, weight: '500' },
                padding: 20
            }
        },
        tooltip: { enabled: true, backgroundColor: 'rgba(30,30,30,0.85)', titleFont: { size: 14, weight: 'bold', color: '#FFFFFF' }, bodyFont: { size: 13, color: '#FFFFFF' }, padding: 10, cornerRadius: 4, titleColor: '#FFFFFF', bodyColor: '#FFFFFF', callbacks: { labelTextColor: function(context) { return '#FFFFFF';
        }}},
        datalabels: { color: '#FFFFFF', anchor: 'end', align: 'start', offset: -10, borderRadius: 4, backgroundColor: 'rgba(0, 0, 0, 0.6)', font: { weight: 'bold', size: 11 }, formatter: (value, context) => { if (context.chart.config.type === 'pie' || context.chart.config.type === 'doughnut') { const sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            return sum > 0 ? (value / sum * 100).toFixed(1) + '%' : '0%'; } return value;
        }}
    };
    const commonPieDoughnutOptions = () => ({ responsive: true, maintainAspectRatio: false, plugins: commonChartPlugins });
    const commonBarScaleOptions = { y: { ticks: { color: '#FFFFFF' }, grid: { color: 'var(--dark-border-color)' }}, x: { ticks: { color: '#FFFFFF' }, grid: { color: 'var(--dark-border-color)' }}};
    // **Step 1: Create the consistently filtered dataset for ALL charts**
    let personnelForCharts = [...allPersonnel];
    // Start with the full dataset

    // Apply all active filters from currentChartFilters
    if (currentChartFilters.autonomyStatus) {
        const targetStatus = currentChartFilters.autonomyStatus;
        personnelForCharts = personnelForCharts.filter(person => {
            const autonomySkill = person.overallSkills.find(s => s.name && s.name.toLowerCase().trim() === "tỉ lệ kỹ năng tự chủ");
            const isAchieved = autonomySkill && parseFloat(autonomySkill.current) >= (parseFloat(autonomySkill.target) || 100);
            if (targetStatus === "Đạt") return isAchieved;
            else if (targetStatus === "Chưa Đạt") return !isAchieved;
            return 
                true;
        });
    }
    if (currentChartFilters.position) {
        personnelForCharts = personnelForCharts.filter(person => person.position === currentChartFilters.position);
    }
    if (currentChartFilters.ageGroup) {
        personnelForCharts = personnelForCharts.filter(person => {
            const age = parseInt(p.age);
            if (isNaN(age)) return false;
            switch (currentChartFilters.ageGroup) {
                case "<25": return age < 25;
                case 
                    "25-30": return age >= 25 && age <= 30;
                case "31-35": return age >= 31 && age <= 35;
                case "36-40": return age >= 36 && age <= 40;
                case "41-50": return age >= 41 && age <= 50;
                case 
                    ">50": return age > 50;
                default: return true;
            }
        });
    }
    if (currentChartFilters.gender) {
        personnelForCharts = personnelForCharts.filter(person => String(person.gender).trim().toUpperCase() === String(currentChartFilters.gender).trim().toUpperCase());
    }

    // **Step 2: Render all charts using the `personnelForCharts` dataset**

    // 1. Tỷ Lệ Kỹ Năng Tự Chủ (Now uses the filtered personnelForCharts)
    const autonomyAchieved = personnelForCharts.filter(p => {
        const skill = p.overallSkills.find(s => s.name && s.name.toLowerCase().trim() === "tỉ lệ kỹ năng tự chủ");
        return skill && parseFloat(skill.current) >= (parseFloat(skill.target) || 100);
    }).length;
    const autonomyNotAchieved = personnelForCharts.length - autonomyAchieved;
    managementAutonomyChartInstance = new Chart(document.getElementById('managementAutonomyChart'), {
        type: 'doughnut',
        data: {
            labels: ['Đạt 100% Tự Chủ', 'Chưa Đạt'],
            datasets: [{ data: [autonomyAchieved, autonomyNotAchieved], backgroundColor: ['#50fa7b', '#FFBF00'], borderColor: 'var(--dark-bg-secondary)' }]
        },
        options: {
            ...commonPieDoughnutOptions(), 
            onClick: (event, elements) => {
                const activeElements = managementAutonomyChartInstance.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (activeElements && activeElements.length > 0) {
                    const clickedElementIndex = activeElements[0].index;
                    const clickedLabel = managementAutonomyChartInstance.data.labels[clickedElementIndex];
                    let filterValue = "";
                    if (clickedLabel === 'Đạt 100% Tự Chủ') { filterValue = "Đạt";
                    }
                    else if (clickedLabel === 'Chưa Đạt') { filterValue = "Chưa Đạt";
                    }

                    if (currentChartFilters.autonomyStatus === filterValue) {
                        delete currentChartFilters.autonomyStatus;
                    } else {
                        currentChartFilters.autonomyStatus = filterValue;
                    }
                    applyManagementFilters();
                }
            }
        }
    });
    // 2. Phân Bố Độ Tuổi (Data calculated from personnelForCharts)
    const ageGroups = { "<25": 0, "25-30": 0, "31-35": 0, "36-40": 0, "41-50": 0, ">50": 0 };
    personnelForCharts.forEach(p => {
        const age = parseInt(p.age);
        if (isNaN(age)) return;
        if (age < 25) ageGroups["<25"]++;
        else if (age >= 25 && age <= 30) ageGroups["25-30"]++;
        else if (age >= 31 && age <= 35) ageGroups["31-35"]++;
        else if (age >= 36 && age <= 40) ageGroups["36-40"]++;
        else if (age >= 41 && 
            age <= 50) ageGroups["41-50"]++;
        else ageGroups[">50"]++;
    });
    managementAgeChartInstance = new Chart(document.getElementById('managementAgeChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(ageGroups),
            datasets: [{ label: 'Số Lượng', data: Object.values(ageGroups), backgroundColor: '#5cadff' }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: commonChartPlugins.tooltip,
                datalabels: { color: '#FFFFFF', anchor: 'end', align: 'top', offset: 4, borderRadius: 4, backgroundColor: 'rgba(0,0,0,0.6)', font: { weight: 'bold', size: 11}, formatter: (value) => value > 0 ? value : '' }
            },
            scales: commonBarScaleOptions,
            onClick: (event, elements) => {
                const activeElements = managementAgeChartInstance.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (activeElements && activeElements.length > 0) {
                    const clickedElementIndex = activeElements[0].index;
                    const clickedLabel = managementAgeChartInstance.data.labels[clickedElementIndex];
                    if (currentChartFilters.ageGroup === clickedLabel) { delete currentChartFilters.ageGroup; } else { currentChartFilters.ageGroup = clickedLabel;
                    }
                    applyManagementFilters();
                }
            }
        }
    });
    // 3. Tỷ Lệ Giới Tính (Data calculated from personnelForCharts)
    const genderChartEl = document.getElementById('managementGenderChart');
    const genderChartMsg = document.getElementById('genderChartMessage');
    genderChartEl.style.display = 'block';
    genderChartMsg.innerText = '';
    const genderCounts = { "NAM": 0, "NỮ": 0 };
    personnelForCharts.forEach(p => {
        const gender = p.gender ? String(p.gender).trim().toUpperCase() : '';
        if (gender === "NAM") genderCounts["NAM"]++;
        else if (gender === "NỮ") genderCounts["NỮ"]++;
    });
    const filteredGenderLabels = Object.keys(genderCounts).filter(key => genderCounts[key] > 0);
    const filteredGenderData = filteredGenderLabels.map(key => genderCounts[key]);
    if (filteredGenderData.length > 0) {
        managementGenderChartInstance = new Chart(genderChartEl, {
            type: 'pie',
            data: {
                labels: filteredGenderLabels,
                datasets: [{ data: filteredGenderData, backgroundColor: ['#2997ff', '#ff6384'], borderColor: 'var(--dark-bg-secondary)' }]
            },
            options: {
                ...commonPieDoughnutOptions(),
                onClick: (event, elements) => {
                    const activeElements = managementGenderChartInstance.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                    if (activeElements 
                        && activeElements.length > 0) {
                        const clickedElementIndex = activeElements[0].index;
                        const clickedLabel = managementGenderChartInstance.data.labels[clickedElementIndex];
                        if (currentChartFilters.gender === clickedLabel) { delete currentChartFilters.gender; } else { currentChartFilters.gender = clickedLabel;
                        }
                        applyManagementFilters();
                    }
                }
            }
        });
    } else {
        genderChartMsg.innerText = "Không có dữ liệu giới tính (NAM/NỮ) hợp lệ để vẽ biểu đồ.";
        genderChartEl.style.display = 'none';
    }

    // 4. Tỷ Lệ Chức Danh (Data calculated from personnelForCharts)
    const positionCounts = {};
    personnelForCharts.forEach(p => {
        const position = (p.position && String(p.position).trim() !== "") ? String(p.position).trim() : "Không xác định";
        positionCounts[position] = (positionCounts[position] || 0) + 1;
    });
    managementPositionChartInstance = new Chart(document.getElementById('managementPositionChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(positionCounts),
            datasets: [{ data: Object.values(positionCounts), backgroundColor: ['#9b59b6', '#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#1abc9c', '#34495e', '#7f8c8d'], borderColor: 'var(--dark-bg-secondary)' }]
        },
        options: {
            ...commonPieDoughnutOptions(),
            onClick: (event, elements) => {
                const activeElements = managementPositionChartInstance.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (activeElements && activeElements.length > 0) {
                    const clickedElementIndex = activeElements[0].index;
                    const clickedLabel = managementPositionChartInstance.data.labels[clickedElementIndex];
                    if (currentChartFilters.position === clickedLabel) { delete currentChartFilters.position; } else { currentChartFilters.position = clickedLabel;
                    }
                    applyManagementFilters();
                }
            }
        }
    });
}
// ==========================================================================================
// HÀM applyManagementFilters() GIỮ NGUYÊN NHƯ FILE GỐC CỦA BẠN (VÌ LOGIC ĐÚNG ĐÃ CÓ)
// ==========================================================================================
function applyManagementFilters() {
    let filteredPersonnel = [...allPersonnel];
    // Áp dụng bộ lọc từ các biểu đồ
    if (currentChartFilters.position) {
        filteredPersonnel = filteredPersonnel.filter(person => person.position === currentChartFilters.position);
    }
    if (currentChartFilters.ageGroup) {
        filteredPersonnel = filteredPersonnel.filter(person => {
            const age = parseInt(p.age);
            if (isNaN(age)) return false;
            switch (currentChartFilters.ageGroup) {
                case "<25": return age < 25;
                case 
                    "25-30": return age >= 25 && age <= 30;
                case "31-35": return age >= 31 && age <= 35;
                case "36-40": return age >= 36 && age <= 40;
                case "41-50": return age >= 41 && age <= 50;
                case 
                    ">50": return age > 50;
                default: return true;
            }
        });
    }
    if (currentChartFilters.gender) {
        filteredPersonnel = filteredPersonnel.filter(person => String(person.gender).trim().toUpperCase() === String(currentChartFilters.gender).trim().toUpperCase());
    }
    // Chỗ này quan trọng: Nếu người dùng click vào biểu đồ Tự chủ, autonomyStatus sẽ được set
    // và nó cũng sẽ được dùng để lọc `filteredPersonnel` cho bảng.
    // Đồng thời, khi renderManagementCharts được gọi lại, nó sẽ dùng autonomyStatus này
    // để lọc `personnelForCharts` cho tất cả các biểu đồ.
    if (currentChartFilters.autonomyStatus) {
        const targetStatus = currentChartFilters.autonomyStatus;
        filteredPersonnel = filteredPersonnel.filter(person => {
            const autonomySkill = person.overallSkills.find(s => s.name && s.name.toLowerCase().trim() === "tỉ lệ kỹ năng tự chủ");
            const isAchieved = autonomySkill && parseFloat(autonomySkill.current) >= (parseFloat(autonomySkill.target) || 100);
            if (targetStatus === "Đạt") {
                return isAchieved;
            } else if (targetStatus 
                === "Chưa Đạt") {
                return !isAchieved;
            }
            return true;
        });
    }


    // Áp dụng bộ lọc "kỹ năng chưa đạt mục tiêu" cuối cùng
    const filterUnmet = document.getElementById('filterUnmetSkills').checked;
    if (filterUnmet) {
        filteredPersonnel = filteredPersonnel.filter(person => {
            const hasUnmetInSkills = person.skills.some(skill =>
                parseFloat(skill.target) > 0 &&
                parseFloat(skill.current) < parseFloat(skill.target)
            );
            return hasUnmetInSkills;
        });
    }
    
    renderManagementCharts();
    displayFilteredPersonnelList(filteredPersonnel);
}


function displayFilteredPersonnelList(personnelToDisplay) {
    const container = document.getElementById('managementPersonnelListContainer');
    container.innerHTML = '';
    if (!personnelToDisplay || personnelToDisplay.length === 0) {
        container.innerHTML = '<p class="no-personnel">Không tìm thấy nhân viên nào phù hợp với bộ lọc.</p>';
        return;
    }

    let html = `
    <table style="width:100%;">
    <thead><tr><th>STT</th><th>Mã NV</th><th>Họ và Tên</th><th>Chức Danh</th><th>Nhóm Vật Tư</th><th>Kỹ Năng Chưa Đạt</th></tr></thead>
    <tbody>`;
    personnelToDisplay.forEach((person, index) => {
        let unmetSkillsDetail = [];
        person.skills.forEach(skill => {
            if (parseFloat(skill.target) > 0 && parseFloat(skill.current) < parseFloat(skill.target)) {
                unmetSkillsDetail.push(`${skill.name} (${skill.current}/${skill.target})`);
            }
        });

        const originalIndex = allPersonnel.findIndex(p => p.employeeCode === person.employeeCode);
        html += `
    
    <tr onclick="showPersonnelDetailsFromManagement(${originalIndex})">
    <td>${index + 1}</td><td>${person.employeeCode || 'N/A'}</td><td>${person.fullName || 'N/A'}</td><td>${person.position || 'N/A'}</td>
    <td>${person.materialGroup || 'N/A'}</td>
    <td class="${unmetSkillsDetail.length > 0 ? 'skill-not-met' : ''}">${unmetSkillsDetail.length > 0 ? unmetSkillsDetail.join('<br>') : 'Đã đạt tất cả'}</td>
    </tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
}

function resetChartFilters() {
    currentChartFilters = {}; // Xóa tất cả bộ lọc
    applyManagementFilters();
    // Áp dụng lại bộ lọc (mà bây giờ đã trống)
}

function showPersonnelDetailsFromManagement(originalIndex) {
    if (originalIndex !== -1 && allPersonnel && originalIndex < allPersonnel.length) {
        showPersonnelDetails(originalIndex);
    } else {
        console.error("Không thể hiển thị chi tiết nhân sự từ trang quản lý, chỉ số không hợp lệ:", originalIndex);
        alert("Không thể tìm thấy thông tin chi tiết cho nhân viên này.");
    }
}


// --- ROADMAP FUNCTIONS ---
function loadRoadmapData() {
    showLoading();
    fetch(`${APPS_SCRIPT_API_URL}?action=getRoadmapData`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            const container = document.getElementById('roadmapContainer');
            container.innerHTML = ''; // Clear previous content

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="no-roadmap-data">Không có dữ liệu lộ trình nào để hiển thị.</p>';
                return;
            }

            // Group data by roadmapName
            const groupedRoadmap = data.reduce((acc, currentItem) => {
                const groupName = currentItem.roadmapName;
                if (!acc[groupName]) {
                    acc[groupName] = [];
                }
                acc[groupName].push(currentItem);
                return acc;
            }, {});

            let fullHtml = '';
            for (const roadmapName in groupedRoadmap) {
                const roadmapItems = groupedRoadmap[roadmapName];
                let totalProgress = 0;
                let validProgressCount = 0; // To count items with valid progress for average calculation
                roadmapItems.forEach(item => {
                    const progress = parseFloat(item.progress);
                    if (!isNaN(progress)) {
                        totalProgress += progress;
                        validProgressCount++;
                    }
                });
                const averageProgress = validProgressCount > 0 ? (totalProgress / validProgressCount).toFixed(0) : 0; // Average, rounded to nearest integer

                fullHtml += `
                <div class="roadmap-group-card">
                    <div class="roadmap-group-header collapsed" onclick="toggleRoadmapGroup(this)">
                        <span>${roadmapName}</span>
                        <span class="progress-info">Tiến độ chung: ${averageProgress}% <i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="roadmap-details">
                        <div class="table-responsive"> <table>
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>BƯỚC</th>
                                        <th>CÔNG VIỆC</th>
                                        <th>BẮT ĐẦU</th>
                                        <th>KẾT THÚC</th>
                                        <th>TUẦN BẮT ĐẦU</th>
                                        <th>TUẦN KẾT THÚC</th>
                                        <th>THỜI GIAN (TUẦN)</th>
                                        <th>CẬP NHẬT TIẾN ĐỘ</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                
                roadmapItems.forEach((row, index) => {
                    let rowClass = '';
                    const startDate = parseRoadmapDate(row.startDate);
                    const endDate = parseRoadmapDate(row.endDate);
                    const progress = parseFloat(row.progress);

                    if (progress === 100) {
                        rowClass = 'roadmap-completed-row';
                    } else if (startDate && endDate && CURRENT_DATE >= startDate && CURRENT_DATE <= endDate) {
                        rowClass = 'roadmap-current-row';
                    }

                    fullHtml += `<tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td>${row.step || ''}</td>
                        <td>${row.task || ''}</td>
                        <td>${row.startDate || ''}</td>
                        <td>${row.endDate || ''}</td>
                        <td>${row.startWeek || ''}</td>
                        <td>${row.endWeek || ''}</td>
                        <td>${row.duration || ''}</td>
                        <td>
                            <select onchange="updateProgress(this, ${row.rowIndex})">`; // Pass original sheet rowIndex
                    for (let i = 0; i <= 100; i += 10) {
                        const selected = (progress === i) ? 'selected' : '';
                        fullHtml += `<option value="${i}" ${selected}>${i}%</option>`;
                    }
                    fullHtml += `
                            </select>
                        </td>
                    </tr>`;
                });

                fullHtml += `</tbody></table></div></div></div>`; /* Closing .table-responsive, .roadmap-details, .roadmap-group-card */
            }
            container.innerHTML = fullHtml;

        })
        .catch(error => {
            hideLoading();
            console.error("Lỗi khi tải dữ liệu lộ trình: ", error);
            document.getElementById('roadmapContainer').innerHTML = '<p class="no-roadmap-data" style="color: var(--status-error-text);">Lỗi khi tải dữ liệu lộ trình: ' + error.message + '</p>';
        });
}

function toggleRoadmapGroup(headerElement) {
    const detailsElement = headerElement.nextElementSibling; // The .roadmap-details div
    headerElement.classList.toggle('collapsed');
    detailsElement.classList.toggle('expanded');
}


function updateProgress(element, rowIndex) {
    const newValue = element.value;
    showLoading();
    fetch(APPS_SCRIPT_API_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'updateRoadmapProgress',
            rowIndex: rowIndex,
            progressValue: newValue
        })
    })
    .then(response => response.json())
    .then(response => {
        hideLoading();
        if (response.success) {
            console.log("Tiến độ đã được cập nhật thành công.");
            // Reload data to update highlighting and average progress
            loadRoadmapData(); 
        } else {
            alert("Lỗi khi cập nhật tiến độ: " + response.message);
            console.error("Lỗi khi cập nhật tiến độ: ", response.message);
        }
    })
    .catch(error => {
        hideLoading();
        alert("Lỗi khi gọi hàm cập nhật tiến độ: " + error.message);
        console.error("Lỗi khi gọi hàm cập nhật tiến độ: ", error);
    });
}



// KHỞI TẠO KHI TẢI TRANG
document.addEventListener('DOMContentLoaded', (event) => {
    applyInitialSidebarState();
    document.getElementById('sidebarToggleBtn').addEventListener('click', toggleSidebar);

    // Kiểm tra trạng thái đăng nhập quản lý từ localStorage khi tải trang
    const storedLoggedIn = localStorage.getItem(MANAGER_LOGGED_IN_KEY);
    const storedFullName = localStorage.getItem(MANAGER_FULL_NAME_KEY);

    if (storedLoggedIn === 'true' && storedFullName) {
        isManagerLoggedIn = true;
        managerFullName = storedFullName;
        // Gọi showManagementScreen() để hiển thị màn hình quản lý và tải dữ liệu
        showManagementScreen(); 
    } else {
        // Nếu không có phiên đăng nhập, hiển thị màn hình đăng nhập ban đầu
        hideAllScreens();
        document.getElementById('loginScreen').classList.remove('hidden');
    }
    currentChartFilters = {}; // Đảm bảo bộ lọc luôn rỗng khi khởi tạo
});
</script>
</body>
</html>